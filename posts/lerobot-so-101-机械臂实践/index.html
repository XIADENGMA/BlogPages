<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>LeRobot SO-101 机械臂实践 &#183; MyBlog</title><meta name=title content="LeRobot SO-101 机械臂实践 &#183; MyBlog"><meta name=description content="My awesome website"><meta name=keywords content="Embodied AI,LeRobot,SO-101,IL,VLA,ACT,"><link rel=canonical href=https://blog.xiadengma.com/posts/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5/><meta name=author content="xiadengma"><link href=https://github.com/xiadengma rel=me><link href=https://xiadengma.com/ rel=me><meta property="og:url" content="https://blog.xiadengma.com/posts/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="MyBlog"><meta property="og:title" content="LeRobot SO-101 机械臂实践"><meta property="og:description" content="My awesome website"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-07T19:48:48+08:00"><meta property="article:modified_time" content="2025-10-20T14:29:01+08:00"><meta property="article:tag" content="Embodied AI"><meta property="article:tag" content="LeRobot"><meta property="article:tag" content="SO-101"><meta property="article:tag" content="IL"><meta property="article:tag" content="VLA"><meta property="article:tag" content="ACT"><meta name=twitter:card content="summary"><meta name=twitter:title content="LeRobot SO-101 机械臂实践"><meta name=twitter:description content="My awesome website"><link type=text/css rel=stylesheet href=/css/main.bundle.min.9edcd5e90f985a2f12ea6c1a3546d0f50284db262580c6808e26b387ce199f389377abb6066f1aaa0027a494415ab36d286c928e71eef8bdf413981a5410fd4a.css integrity="sha512-ntzV6Q+YWi8S6mwaNUbQ9QKE2yYlgMaAjiazh84ZnziTd6u2Bm8aqgAnpJRBWrNtKGySjnHu+L30E5gaVBD9Sg=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP+pSqMXxm6JPOUeAg==" data-copy=复制 data-copied=已复制></script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"文章","name":"LeRobot SO-101 机械臂实践","headline":"LeRobot SO-101 机械臂实践","inLanguage":"en","url":"https:\/\/blog.xiadengma.com\/posts\/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5\/","author":{"@type":"Person","name":"xiadengma"},"copyrightYear":"2025","dateCreated":"2025-10-07T19:48:48\u002b08:00","datePublished":"2025-10-07T19:48:48\u002b08:00","dateModified":"2025-10-20T14:29:01\u002b08:00","keywords":["Embodied AI","LeRobot","SO-101","IL","VLA","ACT"],"mainEntityOfPage":"true","wordCount":"8068"}]</script><script data-id=umami-script async src=https://analytics.umami.is/script.js data-website-id=678aa4f9-0d3a-485e-88ea-9a4e51d5aa9f></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}}</script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js id=MathJax-script></script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
跳过正文</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 min-h-[130px] opacity-65 bg-gradient-to-b from-neutral from-60% dark:from-neutral-800 to-transparent mix-blend-normal z-80"></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>MyBlog</span>
<img src=/img/logo.png width=90 height=90 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium">MyBlog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=文章 title=文章><span class=mr-1><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span><p class="text-base font-medium">文章</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="搜索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="搜索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=文章 title=文章><div class=mr-2><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></div><p class="text-bg font-bg">文章</p></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/img/background_1.svg alt="LeRobot SO-101 机械臂实践" loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/img/background_1.svg></script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>MyBlog</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>文章</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5/>LeRobot SO-101 机械臂实践</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">LeRobot SO-101 机械臂实践</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-10-07T19:48:48+08:00>2025年10月7日</time><span class="px-2 text-primary-500">&#183;</span><time datetime=2025-10-20T14:29:01+08:00>更新:2025年10月20日</time><span class="px-2 text-primary-500">&#183;</span><span>8068 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>38 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/embodied-ai/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Embodied AI
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/lerobot/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">LeRobot
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/so-101/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">SO-101
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/il/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">IL
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/vla/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">VLA
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/act/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">ACT</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#0写在开头>0.写在开头</a></li><li><a href=#硬件连接>硬件连接</a></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#校准>校准</a></li><li><a href=#遥操作示教>遥操作/示教</a><ul><li><a href=#无摄像头遥操作>无摄像头遥操作</a></li><li><a href=#安装摄像头>安装摄像头</a></li><li><a href=#使用摄像头进行遥操作>使用摄像头进行遥操作</a></li></ul></li><li><a href=#录制数据集>录制数据集</a><ul><li><a href=#录制测试数据集>录制测试数据集</a></li><li><a href=#可视化数据集>可视化数据集</a></li><li><a href=#回放数据集>回放数据集</a></li><li><a href=#录制完整数据集>录制完整数据集</a></li></ul></li><li><a href=#训练>训练</a></li><li><a href=#运行推断并评估>运行推断并评估</a></li><li><a href=#88-参考资料><em>88. 参考资料</em></a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#0写在开头>0.写在开头</a></li><li><a href=#硬件连接>硬件连接</a></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#校准>校准</a></li><li><a href=#遥操作示教>遥操作/示教</a><ul><li><a href=#无摄像头遥操作>无摄像头遥操作</a></li><li><a href=#安装摄像头>安装摄像头</a></li><li><a href=#使用摄像头进行遥操作>使用摄像头进行遥操作</a></li></ul></li><li><a href=#录制数据集>录制数据集</a><ul><li><a href=#录制测试数据集>录制测试数据集</a></li><li><a href=#可视化数据集>可视化数据集</a></li><li><a href=#回放数据集>回放数据集</a></li><li><a href=#录制完整数据集>录制完整数据集</a></li></ul></li><li><a href=#训练>训练</a></li><li><a href=#运行推断并评估>运行推断并评估</a></li><li><a href=#88-参考资料><em>88. 参考资料</em></a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">0.写在开头<div id=0写在开头 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#0%e5%86%99%e5%9c%a8%e5%bc%80%e5%a4%b4 aria-label=锚点>#</a></span></h2><blockquote class="book-hint danger"><div class=hint-content><a href=https://github.com/huggingface/lerobot target=_blank>LeRobot 仓库</a>经常性变动，请务必参考官方教程和仓库代码，撰写本文时版本在<code>a6ff3cfe 2025-10-14</code>。</div></blockquote><p>本文记录<code>LeRobot SO-101</code>机械臂实践，包括从硬件连接、环境搭建到基础的校准、采集数据、训练（基于 <code>ACT</code>）、推理（基于 <code>ACT</code>），具体的端口、路径等仅作参考，以实际环境为准。</p><h2 class="relative group">硬件连接<div id=硬件连接 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e7%a1%ac%e4%bb%b6%e8%bf%9e%e6%8e%a5 aria-label=锚点>#</a></span></h2><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-1 class=expand-toggle type=checkbox>
<label for=expand-1 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>成品说明书</label><div class=expand-content><div class=expand-inner><p>WOWROBO SO-ARM101 双臂使用说明书（成品版本专用）</p><ol><li><p>连接与安装
请按以下说明连接设备电源：主控需连接 5V/6A 电源，随从臂连接 12V/8A 电源。
相机组件的安装方法请参考以下视频，在 1 小时 6 分 32 秒（1:06:32） 处开始演示：
链接：https://www.bilibili.com/video/BV13bLyzKES8/</p></li><li><p>操作指南阅读建议
本产品出厂前已完成舵机 ID、波特率、磁编码器中位设置及遥操作功能测试。建议在完全熟悉产品前不要手动更改舵机参数。
请根据以下文档完成环境配置和端口设置后，从步骤 “Calibrate” 开始操作。
链接：https://huggingface.co/docs/lerobot/so101</p></li><li><p>重要事项
错误的标定方向可能导致舵机朝错误的限位方向运行，进而产生过载，造成舵机损坏，尤其是从臂的 3 号舵机。因此，在首次进行遥操作时，请仔细观察每个舵机的运动方向是否与预期一致。如发现方向异常，请立即停止并重新运行标定流程。
这款机械臂的建议最大负载重量为 400 克，请勿超出这个重量，超载可能会损坏舵机。
因操作不当导致的舵机损坏（如过载、烧毁）不在保修范围内，敬请知悉。</p></li></ol></div></div></div><ol><li>由于直接购买的成品<code>LeRobot SO-101</code>，所以无需自己组装零件和设置舵机。</li><li>机械臂连接电源和电脑<ul><li>相机尽量直连电脑，机械臂两条信号线可以通过集线器连接电脑。</li></ul></li><li>安装摄像头<ul><li><a href="https://www.bilibili.com/video/BV13bLyzKES8?t=3991.4" target=_blank>摄像头连接教程</a></li></ul></li></ol><h2 class="relative group">环境搭建<div id=环境搭建 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba aria-label=锚点>#</a></span></h2><p>安装好<code>miniforge</code>和配置<code>conda</code>设置后，参考<a href=https://huggingface.co/docs/lerobot/installation target=_blank>官方-安装文档</a>安装<code>lerobot</code>环境。</p><ol><li>创建虚拟环境：<code>conda create -y -n lerobot python=3.10</code></li><li>激活虚拟环境：<code>conda activate lerobot</code></li><li>安装<code>ffmpeg</code>：<code>conda install ffmpeg -c conda-forge</code></li><li>更新<code>pip</code>：<code>python -m pip install -U pip setuptools wheel</code></li><li>拉取<code>lerobot</code>仓库并进入：<code>git clone https://github.com/huggingface/lerobot.git && cd lerobot</code></li><li>安装<code>lerobot</code>：<code>pip install 'lerobot[all]'</code><ul><li>或者基础的：<code>pip install 'lerobot[feetech]'</code></li></ul></li></ol><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-2 class=expand-toggle type=checkbox>
<label for=expand-2 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>更新到最新 lerobot 库</label><div class=expand-content><div class=expand-inner><ol><li>暂存本地修改：<code>git stash</code></li><li>拉取最新代码：<code>git pull</code></li><li>恢复本地修改：<code>git stash pop</code><ul><li>如果有冲突，需要手动解决</li></ul></li></ol></div></div></div><h2 class="relative group">校准<div id=校准 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%a0%a1%e5%87%86 aria-label=锚点>#</a></span></h2><p>由于我们购买的成品<code>LeRobot SO-101</code>，所以无需自己进行舵机 ID、波特率、磁编码器中位设置，直接进行校准。</p><ul><li>参考视频：<ul><li><a href=https://www.bilibili.com/video/BV1w81mYZEVb target=_blank>LeRobot 具身智能机械臂实操入门课程-01：软件环境配置和双臂标定</a></li><li><a href="https://huggingface.co/docs/lerobot/so101?example=Linux#calibration-video" target=_blank>官方-校准示例视频</a></li></ul></li><li>找到<code>USB</code>端口：<ul><li><a href="https://huggingface.co/docs/lerobot/so101?example=Linux#configure-the-motors" target=_blank>官方-找到机械臂的 USB 端口</a></li></ul></li><li>校准：<ul><li><a href="https://huggingface.co/docs/lerobot/so101?example=Linux#calibrate" target=_blank>官方-校准</a></li><li><a href=https://wiki.seeedstudio.com/cn/lerobot_so100m_new/#%E6%A0%A1%E5%87%86%E6%9C%BA%E6%A2%B0%E8%87%82 target=_blank>Seeed Studio 教程-校准机械臂</a></li></ul></li></ul><ol start=0><li><p>连接机械臂电源和电脑后，激活<code>lerobot</code>环境，进入<code>lerobot</code>仓库。</p></li><li><p>找到两个机械臂的端口：</p><ul><li>通过运行<code>lerobot-find-port</code>，并断开</li><li>找到两个机械臂的端口：<ul><li>主臂（<code>LeaderArm</code>）：<code>/dev/ttyACM0</code></li><li>从臂（<code>FollowerArm</code>）：<code>/dev/ttyACM1</code></li></ul></li></ul></li><li><p>设置串口设备权限：<code>sudo chmod 666 /dev/ttyACM*</code></p><ul><li>如果不想每次连接设备都设置权限，可以把自己加入对应设备组：<ol><li>查看设备组：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>xiadengma@archlinux ~<span class=o>]</span>$ ls -l /dev/ttyACM*
</span></span><span class=line><span class=cl>crw-rw---- <span class=m>1</span> root uucp 166, <span class=m>0</span> 10月16日 13:15 /dev/ttyACM0
</span></span><span class=line><span class=cl>crw-rw---- <span class=m>1</span> root uucp 166, <span class=m>1</span> 10月16日 13:15 /dev/ttyACM1
</span></span></code></pre></div></li><li>把自己加入对应设备组（根据<code>ls -l /dev/ttyACM*</code>输出修改），并验证是否加入成功：<ul><li>加入设备组 uucp 并刷新环境<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo usermod -aG uucp <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exec</span> su -l <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>&#34;</span>
</span></span></code></pre></div></li><li>验证是否加入成功<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>id
</span></span></code></pre></div>结果中组有对应设备组即可。</li></ul></li></ol></li></ul></li><li><p>设置串口设备别名：</p><ul><li><p>如果不想每次连接设备都需要运行<code>lerobot-find-port</code>来查找端口，可以设置别名：</p><ol><li><p>找到设备的唯一属性（<code>/dev/ttyACM0</code>请自行修改）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>udevadm info --query<span class=o>=</span>property --name<span class=o>=</span>/dev/ttyACM0 <span class=p>|</span> sed -n <span class=s1>&#39;s/^ID_SERIAL_SHORT=\(.*\)$/ATTRS{serial}==&#34;\1&#34;/p&#39;</span>
</span></span></code></pre></div><p>输出示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>ATTRS{serial}==&#34;5A7C118736&#34;
</span></span></code></pre></div></li><li><p>创建<code>udev</code>规则文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo touch /etc/udev/rules.d/99-my-robot.rules
</span></span></code></pre></div><p>写入下面内容（<code>serial</code>部分内容请根据实际修改）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl># Rule for the Leader Arm
</span></span><span class=line><span class=cl>SUBSYSTEM==&#34;tty&#34;, ATTRS{serial}==&#34;5A7C118736&#34;, SYMLINK+=&#34;leader_arm&#34;, MODE=&#34;0666&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Rule for the Follower Arm
</span></span><span class=line><span class=cl>SUBSYSTEM==&#34;tty&#34;, ATTRS{serial}==&#34;5A7C118880&#34;, SYMLINK+=&#34;follower_arm&#34;, MODE=&#34;0666&#34;
</span></span></code></pre></div><p>简单解释一下规则：</p><ul><li><code>SUBSYSTEM=="tty"</code>: 表示规则应用于串行设备。</li><li><code>ATTRS{serial}=="..."</code>: 匹配我们找到的唯一设备序列号。</li><li><code>SYMLINK+="leader_arm"</code>: 创建一个名为 <code>/dev/leader_arm</code> 的符号链接（别名）。</li><li><code>MODE="0666"</code>: 这一步将设备文件的权限设置为所有人可读可写，可以避免很多 &ldquo;Permission denied&rdquo; 的错误。</li></ul></li><li><p>重新加载 <code>udev</code>规则并触发</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo udevadm control --reload-rules <span class=o>&amp;&amp;</span> sudo udevadm trigger
</span></span></code></pre></div></li><li><p>验证是否设置成功
拔插一下你的设备，然后运行 <code>ls -l /dev/leader_arm /dev/follower_arm </code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>xiadengma@archlinux ~<span class=o>]</span>$ ls -l /dev/leader_arm /dev/follower_arm
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>7</span> Oct <span class=m>26</span> 15:30 /dev/leader_arm -&gt; ttyACM0
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>7</span> Oct <span class=m>26</span> 15:30 /dev/follower_arm -&gt; ttyACM1
</span></span></code></pre></div></li></ol></li></ul></li><li><p>执行校准</p><ul><li>注意：下面命令都指定了校准文件保存路径，默认路径在<code>~/.cache/huggingface/lerobot/calibration/</code>，如果不指定，可以去掉下面所有命令的<code>--robot.calibration_dir</code>和<code>--teleop.calibration_dir</code>。</li><li>校准过程：运行校准程序，然后将机器人移动到中间位，按下<code>Enter</code>后，再将每个关节在其完整的运动范围内移动。</li></ul><ol><li>校准主臂：<ul><li>主臂名称（可自定义）：<code>my_leader_arm</code></li><li>主臂校准文件保存路径（可自定义）：<code>./data/calibration</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-calibrate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.calibration_dir<span class=o>=</span>./data/calibration
</span></span></code></pre></div></li><li>校准从臂：<ul><li>从臂名称（可自定义）：<code>my_follower_arm</code></li><li>从臂校准文件保存路径（可自定义）：<code>./data/calibration</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-calibrate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --robot.calibration_dir<span class=o>=</span>./data/calibration
</span></span></code></pre></div></li></ol></li><li><p>标定数据解读</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;shoulder_pan&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#肩部旋转关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=err>#</span> <span class=err>电机的唯一标识符，用于在总线通信时精准定位和控制特定电机</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=err>#</span> <span class=err>电机的驱动模式，取值为</span> <span class=err>0</span> <span class=err>表示特定的驱动模式，不同驱动模式会影响电机的运动特性与控制方式</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>56</span><span class=p>,</span> <span class=err>#</span> <span class=err>归位偏移量，指电机从物理零点位置到校准零点位置的偏移量。此参数能保证电机在每次启动时都能回到准确的零点位置，从而提升运动精度</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>829</span><span class=p>,</span> <span class=err>#电机运动范围的最小值和最大值，以数值形式呈现。这两个参数限定了电机的运动边界，避免因超出范围而导致硬件损坏或者运动异常</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>2866</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;shoulder_lift&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#肩部升降关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>463</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>836</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>3136</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;elbow_flex&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#肘部弯曲关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>-100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>894</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>3100</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;wrist_flex&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#腕部弯曲关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>-582</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>928</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>3213</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;wrist_roll&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#腕部旋转关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>-650</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>140</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>3955</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;gripper&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#夹爪关节</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;drive_mode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;homing_offset&#34;</span><span class=p>:</span> <span class=mi>-1229</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_min&#34;</span><span class=p>:</span> <span class=mi>2044</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;range_max&#34;</span><span class=p>:</span> <span class=mi>3461</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ol><h2 class="relative group">遥操作/示教<div id=遥操作示教 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e9%81%a5%e6%93%8d%e4%bd%9c%e7%a4%ba%e6%95%99 aria-label=锚点>#</a></span></h2><ul><li><a href=https://huggingface.co/docs/lerobot/il_robots target=_blank>官方-模仿学习教程</a></li></ul><h3 class="relative group">无摄像头遥操作<div id=无摄像头遥操作 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%97%a0%e6%91%84%e5%83%8f%e5%a4%b4%e9%81%a5%e6%93%8d%e4%bd%9c aria-label=锚点>#</a></span></h3><ol><li>执行遥操作：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-teleoperate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--teleop.calibration_dir<span class=o>=</span>./data/calibration
</span></span></code></pre></div></li><li>运行后摆动主臂，从臂会跟随运动，按<code>Ctrl+C</code>退出</li></ol><h3 class="relative group">安装摄像头<div id=安装摄像头 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%ae%89%e8%a3%85%e6%91%84%e5%83%8f%e5%a4%b4 aria-label=锚点>#</a></span></h3><p>如果在<a href=#%e7%a1%ac%e4%bb%b6%e8%bf%9e%e6%8e%a5>硬件连接</a>中安装了摄像头，可以进行摄像头遥操作。</p><ol start=0><li><p>连接摄像头和电脑（最好有两个，一个摄像头拍操作区域，一个摄像头安装在机械臂腕部）</p></li><li><p>查看摄像头索引和输出</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-find-cameras opencv --output-dir ./data/cameras_images
</span></span></code></pre></div><p>结果输出如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--- Detected Cameras --- <span class=c1># 检测到的相机列表</span>
</span></span><span class=line><span class=cl>Camera <span class=c1>#0: # 相机 0</span>
</span></span><span class=line><span class=cl>  Name: OpenCV Camera @ /dev/video0 <span class=c1># 相机名称及设备路径</span>
</span></span><span class=line><span class=cl>  Type: OpenCV <span class=c1># 相机类型：OpenCV</span>
</span></span><span class=line><span class=cl>  Id: /dev/video0 <span class=c1># 相机 ID，即设备路径</span>
</span></span><span class=line><span class=cl>  Backend api: V4L2 <span class=c1># 使用的后端 API：V4L2</span>
</span></span><span class=line><span class=cl>  Default stream profile: <span class=c1># 默认流配置</span>
</span></span><span class=line><span class=cl>    Format: 0.0 <span class=c1># 格式：0.0（默认设置）</span>
</span></span><span class=line><span class=cl>    Width: <span class=m>640</span> <span class=c1># 图像宽度：640 像素</span>
</span></span><span class=line><span class=cl>    Height: <span class=m>480</span> <span class=c1># 图像高度：480 像素</span>
</span></span><span class=line><span class=cl>    Fps: 30.0 <span class=c1># 每秒帧数：30 帧</span>
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>Camera <span class=c1>#1:</span>
</span></span><span class=line><span class=cl>  Name: OpenCV Camera @ /dev/video2
</span></span><span class=line><span class=cl>  Type: OpenCV
</span></span><span class=line><span class=cl>  Id: /dev/video2
</span></span><span class=line><span class=cl>  Backend api: V4L2
</span></span><span class=line><span class=cl>  Default stream profile:
</span></span><span class=line><span class=cl>    Format: 0.0
</span></span><span class=line><span class=cl>    Width: <span class=m>640</span>
</span></span><span class=line><span class=cl>    Height: <span class=m>480</span>
</span></span><span class=line><span class=cl>    Fps: 30.0
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>Camera <span class=c1>#2:</span>
</span></span><span class=line><span class=cl>  Name: OpenCV Camera @ /dev/video6
</span></span><span class=line><span class=cl>  Type: OpenCV
</span></span><span class=line><span class=cl>  Id: /dev/video6
</span></span><span class=line><span class=cl>  Backend api: V4L2
</span></span><span class=line><span class=cl>  Default stream profile:
</span></span><span class=line><span class=cl>    Format: 0.0
</span></span><span class=line><span class=cl>    Width: <span class=m>640</span>
</span></span><span class=line><span class=cl>    Height: <span class=m>480</span>
</span></span><span class=line><span class=cl>    Fps: 30.0
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>Camera <span class=c1>#3:</span>
</span></span><span class=line><span class=cl>  Name: OpenCV Camera @ /dev/video8
</span></span><span class=line><span class=cl>  Type: OpenCV
</span></span><span class=line><span class=cl>  Id: /dev/video8
</span></span><span class=line><span class=cl>  Backend api: V4L2
</span></span><span class=line><span class=cl>  Default stream profile:
</span></span><span class=line><span class=cl>    Format: 0.0
</span></span><span class=line><span class=cl>    Width: <span class=m>640</span>
</span></span><span class=line><span class=cl>    Height: <span class=m>480</span>
</span></span><span class=line><span class=cl>    Fps: 30.0
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Finalizing image saving...
</span></span><span class=line><span class=cl>Image capture finished. Images saved to data/cameras_images
</span></span></code></pre></div><p>运行完成后会在<code>.data/cameras_images</code>目录下保存图片</p></li><li><p>根据输出记录摄像头：</p><ol><li>手腕左摄像头：<ul><li>名称：<code>wrist_left</code></li><li>索引：<code>2</code></li><li>宽度：<code>640</code></li><li>高度：<code>480</code></li><li>帧率：<code>30</code></li></ul></li><li>机械臂正前方摄像头：<ul><li>名称：<code>front_rgb</code></li><li>索引：<code>8</code></li><li>宽度：<code>640</code></li><li>高度：<code>480</code></li><li>帧率：<code>30</code></li></ul></li></ol></li></ol><h3 class="relative group">使用摄像头进行遥操作<div id=使用摄像头进行遥操作 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e4%bd%bf%e7%94%a8%e6%91%84%e5%83%8f%e5%a4%b4%e8%bf%9b%e8%a1%8c%e9%81%a5%e6%93%8d%e4%bd%9c aria-label=锚点>#</a></span></h3><ol><li>执行遥操作：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-teleoperate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --display_data<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div></li><li>运行后会打开<code>rerun</code>窗口，可以查看机械臂和摄像头画面</li><li>摆动主臂，从臂会跟随运动，按<code>Ctrl+C</code>退出</li></ol><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-3 class=expand-toggle type=checkbox>
<label for=expand-3 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>ReRun Web 可视化</label><div class=expand-content><div class=expand-inner><ol><li><p>在<code>src/lerobot</code>下创建<code>extra</code>文件夹，并添加<code>web_visualization_utils.py</code>和<code>lerobot_teleoperate_web.py</code>两个文件，内容如下：</p><ul><li><p><code>web_visualization_utils.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;Web-based visualization utilities using Rerun web viewer.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numbers</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>rerun</span> <span class=k>as</span> <span class=nn>rr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.constants</span> <span class=kn>import</span> <span class=n>OBS_PREFIX</span><span class=p>,</span> <span class=n>OBS_STR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_rerun_web</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>session_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;lerobot_control_loop&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>9090</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>open_browser</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_limit</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;10%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    初始化 Rerun SDK 用于 Web 浏览器可视化控制循环。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Initializes the Rerun SDK for visualizing the control loop in a web browser.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参数 Args:
</span></span></span><span class=line><span class=cl><span class=s2>        session_name: Rerun 会话名称 / Name of the Rerun session
</span></span></span><span class=line><span class=cl><span class=s2>        port: Web 服务器端口 / Web server port (default: 9090)
</span></span></span><span class=line><span class=cl><span class=s2>        open_browser: 是否自动打开浏览器 / Whether to automatically open browser (default: True)
</span></span></span><span class=line><span class=cl><span class=s2>        memory_limit: 内存限制 / Memory limit for Rerun (default: &#34;10%&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用示例 Example:
</span></span></span><span class=line><span class=cl><span class=s2>        ```python
</span></span></span><span class=line><span class=cl><span class=s2>        from lerobot.extra.web_visualization_utils import init_rerun_web
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        # 在浏览器中启动可视化 / Start visualization in browser
</span></span></span><span class=line><span class=cl><span class=s2>        init_rerun_web(session_name=&#34;my_teleoperation&#34;, port=9090)
</span></span></span><span class=line><span class=cl><span class=s2>        ```
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    访问 Access:
</span></span></span><span class=line><span class=cl><span class=s2>        在浏览器中打开 / Open in browser: http://localhost:9090
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;RERUN_FLUSH_NUM_BYTES&#34;</span><span class=p>,</span> <span class=s2>&#34;8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;RERUN_FLUSH_NUM_BYTES&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>batch_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>session_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🌐 启动 Rerun Web Viewer / Starting Rerun Web Viewer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📍 访问地址 / Access URL: http://localhost:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;💾 内存限制 / Memory limit: </span><span class=si>{</span><span class=n>memory_limit</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>serve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>open_browser</span><span class=o>=</span><span class=n>open_browser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>web_port</span><span class=o>=</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>server_memory_limit</span><span class=o>=</span><span class=n>memory_limit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_rerun_connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1:9876&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>session_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;lerobot_control_loop&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    连接到远程 Rerun Viewer (适用于远程服务器)。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Connect to a remote Rerun Viewer (useful for remote servers).
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参数 Args:
</span></span></span><span class=line><span class=cl><span class=s2>        addr: 远程 Rerun Viewer 地址 / Remote Rerun Viewer address (default: &#34;127.0.0.1:9876&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>        session_name: Rerun 会话名称 / Name of the Rerun session
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用示例 Example:
</span></span></span><span class=line><span class=cl><span class=s2>        ```python
</span></span></span><span class=line><span class=cl><span class=s2>        from lerobot.extra.web_visualization_utils import init_rerun_connect
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        # 连接到远程 Rerun Viewer / Connect to remote Rerun Viewer
</span></span></span><span class=line><span class=cl><span class=s2>        # 首先在另一个终端运行: rerun --port 9876
</span></span></span><span class=line><span class=cl><span class=s2>        # First run in another terminal: rerun --port 9876
</span></span></span><span class=line><span class=cl><span class=s2>        init_rerun_connect(addr=&#34;127.0.0.1:9876&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>        ```
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;RERUN_FLUSH_NUM_BYTES&#34;</span><span class=p>,</span> <span class=s2>&#34;8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;RERUN_FLUSH_NUM_BYTES&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>batch_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>session_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🔗 连接到远程 Rerun Viewer / Connecting to remote Rerun Viewer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📍 地址 / Address: </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>connect_tcp</span><span class=p>(</span><span class=n>addr</span><span class=o>=</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_is_scalar</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=p>(</span><span class=nb>float</span> <span class=o>|</span> <span class=n>numbers</span><span class=o>.</span><span class=n>Real</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>integer</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>floating</span><span class=p>))</span> <span class=ow>or</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=ow>and</span> <span class=n>x</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_rerun_data</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>observation</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    将观测和动作数据记录到 Rerun 用于实时可视化。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Logs observation and action data to Rerun for real-time visualization.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    This function iterates through the provided observation and action dictionaries and sends their contents
</span></span></span><span class=line><span class=cl><span class=s2>    to the Rerun viewer. It handles different data types appropriately:
</span></span></span><span class=line><span class=cl><span class=s2>    - Scalar values (floats, ints) are logged as `rr.Scalar`.
</span></span></span><span class=line><span class=cl><span class=s2>    - 3D NumPy arrays that resemble images (e.g., with 1, 3, or 4 channels first) are transposed
</span></span></span><span class=line><span class=cl><span class=s2>      from CHW to HWC format and logged as `rr.Image`.
</span></span></span><span class=line><span class=cl><span class=s2>    - 1D NumPy arrays are logged as a series of individual scalars, with each element indexed.
</span></span></span><span class=line><span class=cl><span class=s2>    - Other multi-dimensional arrays are flattened and logged as individual scalars.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Keys are automatically namespaced with &#34;observation.&#34; or &#34;action.&#34; if not already present.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参数 Args:
</span></span></span><span class=line><span class=cl><span class=s2>        observation: 包含观测数据的可选字典 / An optional dictionary containing observation data to log.
</span></span></span><span class=line><span class=cl><span class=s2>        action: 包含动作数据的可选字典 / An optional dictionary containing action data to log.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>observation</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>observation</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>v</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>k</span> <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>k</span><span class=p>)</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>OBS_PREFIX</span><span class=p>)</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>OBS_STR</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>_is_scalar</span><span class=p>(</span><span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>v</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>arr</span> <span class=o>=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>                <span class=c1># Convert CHW -&gt; HWC when needed</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>arr</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>3</span> <span class=ow>and</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span> <span class=ow>and</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>arr</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>vi</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>vi</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>arr</span><span class=p>),</span> <span class=n>static</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>action</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>action</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>v</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>k</span> <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>k</span><span class=p>)</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;action.&#34;</span><span class=p>)</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;action.</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>_is_scalar</span><span class=p>(</span><span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>v</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>v</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>vi</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>vi</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># Fall back to flattening higher-dimensional arrays</span>
</span></span><span class=line><span class=cl>                    <span class=n>flat</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>vi</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>flat</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>vi</span><span class=p>)))</span>
</span></span></code></pre></div></li><li><p><code>lerobot_teleoperate_web.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>通过遥操作控制机器人的脚本 (使用 Web 可视化)。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Simple script to control a robot from teleoperation (with Web visualization).
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>asdict</span><span class=p>,</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pprint</span> <span class=kn>import</span> <span class=n>pformat</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>rerun</span> <span class=k>as</span> <span class=nn>rr</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.cameras.opencv.configuration_opencv</span> <span class=kn>import</span> <span class=n>OpenCVCameraConfig</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.cameras.realsense.configuration_realsense</span> <span class=kn>import</span> <span class=n>RealSenseCameraConfig</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.configs</span> <span class=kn>import</span> <span class=n>parser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.processor</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>RobotAction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RobotObservation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RobotProcessorPipeline</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>make_default_processors</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.robots</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Robot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RobotConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bi_so100_follower</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>hope_jr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>koch_follower</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>make_robot_from_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>so100_follower</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>so101_follower</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.teleoperators</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Teleoperator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>TeleoperatorConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bi_so100_leader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>gamepad</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>homunculus</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>koch_leader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>make_teleoperator_from_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>so100_leader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>so101_leader</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.robot_utils</span> <span class=kn>import</span> <span class=n>busy_wait</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.utils</span> <span class=kn>import</span> <span class=n>init_logging</span><span class=p>,</span> <span class=n>move_cursor_up</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.web_visualization_utils</span> <span class=kn>import</span> <span class=n>init_rerun_web</span><span class=p>,</span> <span class=n>log_rerun_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TeleoperateWebConfig</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>teleop</span><span class=p>:</span> <span class=n>TeleoperatorConfig</span>
</span></span><span class=line><span class=cl>    <span class=n>robot</span><span class=p>:</span> <span class=n>RobotConfig</span>
</span></span><span class=line><span class=cl>    <span class=c1># Limit the maximum frames per second.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 限制最大帧率</span>
</span></span><span class=line><span class=cl>    <span class=n>fps</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=n>teleop_time_s</span><span class=p>:</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=c1># Display all cameras on screen</span>
</span></span><span class=line><span class=cl>    <span class=c1># 在屏幕上显示所有摄像头</span>
</span></span><span class=line><span class=cl>    <span class=n>display_data</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=c1># Web viewer port</span>
</span></span><span class=line><span class=cl>    <span class=c1># Web 查看器端口</span>
</span></span><span class=line><span class=cl>    <span class=n>web_port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>9090</span>
</span></span><span class=line><span class=cl>    <span class=c1># Auto open browser</span>
</span></span><span class=line><span class=cl>    <span class=c1># 自动打开浏览器</span>
</span></span><span class=line><span class=cl>    <span class=n>open_browser</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>teleop_loop</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>teleop</span><span class=p>:</span> <span class=n>Teleoperator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>robot</span><span class=p>:</span> <span class=n>Robot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fps</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>teleop_action_processor</span><span class=p>:</span> <span class=n>RobotProcessorPipeline</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>RobotAction</span><span class=p>,</span> <span class=n>RobotObservation</span><span class=p>],</span> <span class=n>RobotAction</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>robot_action_processor</span><span class=p>:</span> <span class=n>RobotProcessorPipeline</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>RobotAction</span><span class=p>,</span> <span class=n>RobotObservation</span><span class=p>],</span> <span class=n>RobotAction</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>robot_observation_processor</span><span class=p>:</span> <span class=n>RobotProcessorPipeline</span><span class=p>[</span><span class=n>RobotObservation</span><span class=p>,</span> <span class=n>RobotObservation</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>display_data</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    This function continuously reads actions from a teleoperation device, processes them through optional
</span></span></span><span class=line><span class=cl><span class=s2>    pipelines, sends them to a robot, and optionally displays the robot&#39;s state. The loop runs at a
</span></span></span><span class=line><span class=cl><span class=s2>    specified frequency until a set duration is reached or it is manually interrupted.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        teleop: The teleoperator device instance providing control actions.
</span></span></span><span class=line><span class=cl><span class=s2>        robot: The robot instance being controlled.
</span></span></span><span class=line><span class=cl><span class=s2>        fps: The target frequency for the control loop in frames per second.
</span></span></span><span class=line><span class=cl><span class=s2>        display_data: If True, fetches robot observations and displays them in the console and Rerun.
</span></span></span><span class=line><span class=cl><span class=s2>        duration: The maximum duration of the teleoperation loop in seconds. If None, the loop runs indefinitely.
</span></span></span><span class=line><span class=cl><span class=s2>        teleop_action_processor: An optional pipeline to process raw actions from the teleoperator.
</span></span></span><span class=line><span class=cl><span class=s2>        robot_action_processor: An optional pipeline to process actions before they are sent to the robot.
</span></span></span><span class=line><span class=cl><span class=s2>        robot_observation_processor: An optional pipeline to process raw observations from the robot.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>display_len</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>robot</span><span class=o>.</span><span class=n>action_features</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>loop_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Get robot observation</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取机器人观测</span>
</span></span><span class=line><span class=cl>        <span class=n>obs</span> <span class=o>=</span> <span class=n>robot</span><span class=o>.</span><span class=n>get_observation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Get teleop action</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取遥操作动作</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_action</span> <span class=o>=</span> <span class=n>teleop</span><span class=o>.</span><span class=n>get_action</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Process teleop action through pipeline</span>
</span></span><span class=line><span class=cl>        <span class=c1># 通过处理流水线处理遥操作动作</span>
</span></span><span class=line><span class=cl>        <span class=n>teleop_action</span> <span class=o>=</span> <span class=n>teleop_action_processor</span><span class=p>((</span><span class=n>raw_action</span><span class=p>,</span> <span class=n>obs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Process action for robot through pipeline</span>
</span></span><span class=line><span class=cl>        <span class=c1># 通过处理流水线生成发送给机器人的动作</span>
</span></span><span class=line><span class=cl>        <span class=n>robot_action_to_send</span> <span class=o>=</span> <span class=n>robot_action_processor</span><span class=p>((</span><span class=n>teleop_action</span><span class=p>,</span> <span class=n>obs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Send processed action to robot</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送处理后的动作给机器人</span>
</span></span><span class=line><span class=cl>        <span class=n>_</span> <span class=o>=</span> <span class=n>robot</span><span class=o>.</span><span class=n>send_action</span><span class=p>(</span><span class=n>robot_action_to_send</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>display_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Process robot observation through pipeline</span>
</span></span><span class=line><span class=cl>            <span class=c1># 通过处理流水线处理机器人观测</span>
</span></span><span class=line><span class=cl>            <span class=n>obs_transition</span> <span class=o>=</span> <span class=n>robot_observation_processor</span><span class=p>(</span><span class=n>obs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>log_rerun_data</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>observation</span><span class=o>=</span><span class=n>obs_transition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=n>teleop_action</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=n>display_len</span> <span class=o>+</span> <span class=mi>10</span><span class=p>))</span>  <span class=c1># 分隔线</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;NAME&#39;</span><span class=si>:</span><span class=s2>&lt;</span><span class=si>{</span><span class=n>display_len</span><span class=si>}}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;NORM&#39;</span><span class=si>:</span><span class=s2>&gt;7</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 标题：名称与归一化值</span>
</span></span><span class=line><span class=cl>            <span class=c1># Display the final robot action that was sent</span>
</span></span><span class=line><span class=cl>            <span class=c1># 显示已发送给机器人的最终动作</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>motor</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>robot_action_to_send</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>motor</span><span class=si>:</span><span class=s2>&lt;</span><span class=si>{</span><span class=n>display_len</span><span class=si>}}</span><span class=s2> | </span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>&gt;7.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 每个电机的动作值（保留 2 位小数）</span>
</span></span><span class=line><span class=cl>            <span class=n>move_cursor_up</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>robot_action_to_send</span><span class=p>)</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span>  <span class=c1># 上移光标以覆盖刷新</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dt_s</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>loop_start</span>
</span></span><span class=line><span class=cl>        <span class=n>busy_wait</span><span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>fps</span> <span class=o>-</span> <span class=n>dt_s</span><span class=p>)</span>  <span class=c1># 忙等待以维持目标帧率（若剩余时间为正）</span>
</span></span><span class=line><span class=cl>        <span class=n>loop_s</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>loop_start</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>time: </span><span class=si>{</span><span class=n>loop_s</span> <span class=o>*</span> <span class=mf>1e3</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>ms (</span><span class=si>{</span><span class=mi>1</span> <span class=o>/</span> <span class=n>loop_s</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> Hz)&#34;</span><span class=p>)</span>  <span class=c1># 打印单次循环耗时与频率</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>duration</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span> <span class=o>&gt;=</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@parser.wrap</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>teleoperate_web</span><span class=p>(</span><span class=n>cfg</span><span class=p>:</span> <span class=n>TeleoperateWebConfig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init_logging</span><span class=p>()</span>  <span class=c1># 初始化日志</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>pformat</span><span class=p>(</span><span class=n>asdict</span><span class=p>(</span><span class=n>cfg</span><span class=p>)))</span>  <span class=c1># 记录当前配置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>display_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 Web 可视化</span>
</span></span><span class=line><span class=cl>        <span class=n>init_rerun_web</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>session_name</span><span class=o>=</span><span class=s2>&#34;teleoperation_web&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>web_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>open_browser</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>open_browser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>teleop</span> <span class=o>=</span> <span class=n>make_teleoperator_from_config</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>teleop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>robot</span> <span class=o>=</span> <span class=n>make_robot_from_config</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>robot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>teleop_action_processor</span><span class=p>,</span> <span class=n>robot_action_processor</span><span class=p>,</span> <span class=n>robot_observation_processor</span> <span class=o>=</span> <span class=n>make_default_processors</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>teleop</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>  <span class=c1># 连接遥操作设备</span>
</span></span><span class=line><span class=cl>    <span class=n>robot</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>  <span class=c1># 连接机器人</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>teleop_loop</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>teleop</span><span class=o>=</span><span class=n>teleop</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>robot</span><span class=o>=</span><span class=n>robot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>fps</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>fps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>display_data</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>display_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>teleop_time_s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>teleop_action_processor</span><span class=o>=</span><span class=n>teleop_action_processor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>robot_action_processor</span><span class=o>=</span><span class=n>robot_action_processor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>robot_observation_processor</span><span class=o>=</span><span class=n>robot_observation_processor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>  <span class=c1># 捕获 Ctrl+C 中断，正常退出</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>display_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rr</span><span class=o>.</span><span class=n>rerun_shutdown</span><span class=p>()</span>  <span class=c1># 关闭 Rerun 会话</span>
</span></span><span class=line><span class=cl>        <span class=n>teleop</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>  <span class=c1># 断开遥操作设备</span>
</span></span><span class=line><span class=cl>        <span class=n>robot</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>  <span class=c1># 断开机器人</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>teleoperate_web</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div></li></ul></li><li><p>执行遥操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_teleoperate_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --teleop.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --display_data<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --web_port<span class=o>=</span><span class=m>9090</span>
</span></span></code></pre></div></li><li><p>运行后默认情况下会在浏览器打开<code>http://localhost:9090/?url=ws://localhost:9877</code>，可以查看机械臂和摄像头画面</p></li><li><p>摆动主臂，从臂会跟随运动，按<code>Ctrl+C</code>退出</p></li></ol></div></div></div><h2 class="relative group">录制数据集<div id=录制数据集 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%bd%95%e5%88%b6%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=锚点>#</a></span></h2><ul><li><p><a href=https://www.bilibili.com/video/BV1HtDdYfEPk target=_blank>LeRobot 具身智能机械臂实操入门课程-03：机械臂的数据集录制与模型训练</a></p></li><li><p><a href=https://huggingface.co/blog/lerobot-datasets#what-makes-a-good-dataset target=_blank>官方-优质数据集要求</a></p></li><li><p><a href=https://huggingface.co/docs/lerobot/il_robots#record-a-dataset target=_blank>官方-录制数据集教程</a></p></li><li><p>每个回合录制流程：等待程序提示录制当前回合，通过主臂遥操作机械臂进行抓取，抓取结束后，将机械臂恢复到休息位再结束当前回合，等待程序记录数据的同时重置抓取环境，等待程序提示录制下一个回合。</p></li><li><p>键盘控制说明：</p><table><thead><tr><th>按键</th><th>何时使用</th><th>作用</th></tr></thead><tbody><tr><td>右箭头 (→)</td><td>在当前回合采集期间，并且你已成功完成任务</td><td>成功并提前结束 当前 回合，保存数据，然后进入重置阶段。</td></tr><tr><td>左箭头 (←)</td><td>在当前回合采集期间，但你犯了个错误</td><td>作废并重新开始 当前 回合。这次的录制数据会被丢弃。</td></tr><tr><td>ESC 键</td><td>任何时候</td><td>完全终止 整个采集会话。程序会保存已完成的数据并退出。</td></tr></tbody></table></li></ul><h3 class="relative group">录制测试数据集<div id=录制测试数据集 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%bd%95%e5%88%b6%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=锚点>#</a></span></h3><ul><li>采集次数：5 次</li><li>采集任务（请自定义修改）：<code>Put the red pepper toy in the cardboard box</code></li><li>采集数据保存路径：<code>./data/datasets/xiadengma/record-test-so101</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-record <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --display_data<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.repo_id<span class=o>=</span>xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.num_episodes<span class=o>=</span><span class=m>5</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.single_task<span class=o>=</span><span class=s2>&#34;Put the red pepper toy in the cardboard box&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.push_to_hub<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.root<span class=o>=</span>./data/datasets/xiadengma/record-test-so101
</span></span></code></pre></div><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-4 class=expand-toggle type=checkbox>
<label for=expand-4 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>ReRun Web 可视化</label><div class=expand-content><div class=expand-inner><ol><li><p>在<code>src/lerobot</code>下的<code>extra</code>文件夹中添加<code>web_visualization_utils.py</code>和<code>lerobot_record_web.py</code>两个文件，内容如下：</p><ul><li><p><code>web_visualization_utils.py</code>：
在<a href=#%e4%bd%bf%e7%94%a8%e6%91%84%e5%83%8f%e5%a4%b4%e8%bf%9b%e8%a1%8c%e9%81%a5%e6%93%8d%e4%bd%9c>### 使用摄像头进行遥操作</a>中有，按步骤来这里不需要再做。</p></li><li><p><code>lerobot_record_web.py</code>：</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>录制数据集 (使用 Web 可视化)。机器人动作可由遥操作或策略生成。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Records a dataset (with Web visualization). Actions for the robot can be either generated by teleoperation or by a policy.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用示例 Example:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>```shell
</span></span></span><span class=line><span class=cl><span class=s2>python -m lerobot.extra.lerobot_record_web </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --robot.type=so101_follower </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --robot.port=/dev/ttyACM0 </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --robot.cameras=&#34;{front: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}}&#34; </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --robot.id=my_follower_arm </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --teleop.type=so101_leader </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --teleop.port=/dev/ttyACM1 </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --teleop.id=my_leader_arm </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --dataset.repo_id=&lt;my_username&gt;/&lt;my_dataset_name&gt; </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --dataset.num_episodes=50 </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --dataset.single_task=&#34;Grab the black cube&#34; </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --display_data=true </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --web_port=9090
</span></span></span></code></pre></div><p>然后在浏览器中打开 / Then open in browser: http://localhost:9090
"""</p><p>import logging
import time
from dataclasses import asdict, dataclass, field
from pathlib import Path
from pprint import pformat
from typing import Any</p><p>from lerobot.cameras import ( # noqa: F401
CameraConfig, # noqa: F401
)
from lerobot.cameras.opencv.configuration_opencv import OpenCVCameraConfig # noqa: F401
from lerobot.cameras.realsense.configuration_realsense import RealSenseCameraConfig # noqa: F401
from lerobot.configs import parser
from lerobot.configs.policies import PreTrainedConfig
from lerobot.datasets.image_writer import safe_stop_image_writer
from lerobot.datasets.lerobot_dataset import LeRobotDataset
from lerobot.datasets.pipeline_features import aggregate_pipeline_dataset_features, create_initial_features
from lerobot.datasets.utils import build_dataset_frame, combine_feature_dicts
from lerobot.datasets.video_utils import VideoEncodingManager
from lerobot.policies.factory import make_policy, make_pre_post_processors
from lerobot.policies.pretrained import PreTrainedPolicy
from lerobot.policies.utils import make_robot_action
from lerobot.processor import (
PolicyAction,
PolicyProcessorPipeline,
RobotAction,
RobotObservation,
RobotProcessorPipeline,
make_default_processors,
)
from lerobot.processor.rename_processor import rename_stats
from lerobot.robots import ( # noqa: F401
Robot,
RobotConfig,
bi_so100_follower, # noqa: F401
hope_jr, # noqa: F401
koch_follower, # noqa: F401
make_robot_from_config,
so100_follower, # noqa: F401
so101_follower, # noqa: F401
)
from lerobot.teleoperators import ( # noqa: F401
Teleoperator,
TeleoperatorConfig,
bi_so100_leader, # noqa: F401
homunculus, # noqa: F401
koch_leader,
make_teleoperator_from_config,
so100_leader,
so101_leader,
)
from lerobot.teleoperators.keyboard.teleop_keyboard import KeyboardTeleop
from lerobot.utils.constants import ACTION, OBS_STR
from lerobot.utils.control_utils import (
init_keyboard_listener,
is_headless,
predict_action,
sanity_check_dataset_name,
sanity_check_dataset_robot_compatibility,
)
from lerobot.utils.import_utils import register_third_party_devices
from lerobot.utils.robot_utils import busy_wait
from lerobot.utils.utils import (
get_safe_torch_device,
init_logging,
log_say,
)</p><h1 class="relative group">导入 Web 可视化工具 / Import web visualization utilities<div id=导入-web-可视化工具--import-web-visualization-utilities class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%af%bc%e5%85%a5-web-%e5%8f%af%e8%a7%86%e5%8c%96%e5%b7%a5%e5%85%b7--import-web-visualization-utilities aria-label=锚点>#</a></span></h1><p>from .web_visualization_utils import init_rerun_web, log_rerun_data</p><p>@dataclass
class DatasetRecordConfig: # Dataset identifier. By convention it should match &lsquo;{hf_username}/{dataset_name}&rsquo; (e.g. <code>lerobot/test</code>). # 数据集标识符，按约定为"用户名/数据集名"
repo_id: str # A short but accurate description of the task performed during the recording (e.g. &ldquo;Pick the Lego block and drop it in the box on the right.&rdquo;) # 对录制任务的简短准确描述
single_task: str # Root directory where the dataset will be stored (e.g. &lsquo;dataset/path&rsquo;). # 数据集保存的根目录
root: str | Path | None = None # Limit the frames per second. # 限制帧率
fps: int = 30 # Number of seconds for data recording for each episode. # 每个 episode 的录制时长（秒）
episode_time_s: int | float = 60 # Number of seconds for resetting the environment after each episode. # 每个 episode 后重置环境的时长（秒）
reset_time_s: int | float = 60 # Number of episodes to record. # 录制的 episode 数量
num_episodes: int = 50 # Encode frames in the dataset into video # 是否将帧编码为视频
video: bool = True # Upload dataset to Hugging Face hub. # 是否上传到 Hugging Face Hub
push_to_hub: bool = True # Upload on private repository on the Hugging Face hub. # 是否上传到私有仓库
private: bool = False # Add tags to your dataset on the hub. # 为数据集添加标签
tags: list[str] | None = None # Number of subprocesses handling the saving of frames as PNG. Set to 0 to use threads only; # 负责保存 PNG 帧的子进程数；设为 0 仅用线程 # set to ≥1 to use subprocesses, each using threads to write images. The best number of processes # 设为 ≥1 时使用子进程，每个子进程内使用线程 # and threads depends on your system. We recommend 4 threads per camera with 0 processes. # 进程与线程数取决于系统，建议每个相机 4 线程、0 子进程 # If fps is unstable, adjust the thread count. If still unstable, try using 1 or more subprocesses. # fps 不稳先调线程数；若仍不稳尝试增加子进程
num_image_writer_processes: int = 0 # Number of threads writing the frames as png images on disk, per camera. # 每个相机写 PNG 的线程数 # Too many threads might cause unstable teleoperation fps due to main thread being blocked. # 线程过多可能阻塞主线程导致遥操作 fps 不稳 # Not enough threads might cause low camera fps. # 线程过少可能导致相机 fps 低
num_image_writer_threads_per_camera: int = 4 # Number of episodes to record before batch encoding videos # 批量编码视频前要累计的 episode 数 # Set to 1 for immediate encoding (default behavior), or higher for batched encoding # 1 表示立即编码（默认），更大表示批量
video_encoding_batch_size: int = 1 # Rename map for the observation to override the image and state keys # 覆盖图像与状态键名的重命名映射
rename_map: dict[str, str] = field(default_factory=dict)</p><pre><code>def __post_init__(self):
    if self.single_task is None:
        raise ValueError(&quot;You need to provide a task as argument in `single_task`.&quot;)
</code></pre><p>@dataclass
class RecordWebConfig:
robot: RobotConfig
dataset: DatasetRecordConfig # Whether to control the robot with a teleoperator # 是否使用遥操作控制机器人
teleop: TeleoperatorConfig | None = None # Whether to control the robot with a policy # 是否使用策略控制机器人
policy: PreTrainedConfig | None = None # Display all cameras on screen # 是否在屏幕显示所有摄像头
display_data: bool = False # Use vocal synthesis to read events. # 是否用语音播报事件
play_sounds: bool = True # Resume recording on an existing dataset. # 继续录制已有数据集
resume: bool = False # Web viewer port # Web 查看器端口
web_port: int = 9090 # Auto open browser # 自动打开浏览器
open_browser: bool = True</p><pre><code>def __post_init__(self):
    # HACK: We parse again the cli args here to get the pretrained path if there was one.
    # 再次解析 CLI 以获取预训练路径（若存在）
    policy_path = parser.get_path_arg(&quot;policy&quot;)
    if policy_path:
        cli_overrides = parser.get_cli_overrides(&quot;policy&quot;)
        self.policy = PreTrainedConfig.from_pretrained(policy_path, cli_overrides=cli_overrides)
        self.policy.pretrained_path = policy_path

    if self.teleop is None and self.policy is None:
        raise ValueError(&quot;Choose a policy, a teleoperator or both to control the robot&quot;)

@classmethod
def __get_path_fields__(cls) -&gt; list[str]:
    &quot;&quot;&quot;This enables the parser to load config from the policy using `--policy.path=local/dir`&quot;&quot;&quot;  # 允许解析器通过 --policy.path 加载配置
    return [&quot;policy&quot;]
</code></pre><p>""" &mdash;&mdash;&mdash;&mdash;&mdash; record_loop() data flow &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
[ Robot ]
V
[ robot.get_observation() ] &mdash;> raw_obs
V
[ robot_observation_processor ] &mdash;> processed_obs
V
.&mdash;&ndash;( ACTION LOGIC )&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;.
V V
[ From Teleoperator ] [ From Policy ]
| |
| [teleop.get_action] -> raw_action | [predict_action]
| | | |
| V | V
| [teleop_action_processor] | |
| | | |
&lsquo;&mdash;> processed_teleop_action &lsquo;&mdash;> processed_policy_action
| |
&lsquo;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-.&mdash;&mdash;&mdash;&mdash;-&rsquo;
V
[ robot_action_processor ] &ndash;> robot_action_to_send
V
[ robot.send_action() ] &ndash; (Robot Executes)
V
( Save to Dataset )
V
( Rerun Log / Loop Wait )
"""</p><p>@safe_stop_image_writer
def record_loop(
robot: Robot,
events: dict,
fps: int,
teleop_action_processor: RobotProcessorPipeline[
tuple[RobotAction, RobotObservation], RobotAction
], # runs after teleop # 在遥操作之后运行
robot_action_processor: RobotProcessorPipeline[
tuple[RobotAction, RobotObservation], RobotAction
], # runs before robot # 在发送到机器人之前运行
robot_observation_processor: RobotProcessorPipeline[
RobotObservation, RobotObservation
], # runs after robot # 在机器人观测之后运行
dataset: LeRobotDataset | None = None,
teleop: Teleoperator | list[Teleoperator] | None = None,
policy: PreTrainedPolicy | None = None,
preprocessor: PolicyProcessorPipeline[dict[str, Any], dict[str, Any]] | None = None,
postprocessor: PolicyProcessorPipeline[PolicyAction, PolicyAction] | None = None,
control_time_s: int | None = None,
single_task: str | None = None,
display_data: bool = False,
):
if dataset is not None and dataset.fps != fps:
raise ValueError(f"The dataset fps should be equal to requested fps ({dataset.fps} != {fps}).")</p><pre><code>teleop_arm = teleop_keyboard = None
if isinstance(teleop, list):
    teleop_keyboard = next((t for t in teleop if isinstance(t, KeyboardTeleop)), None)
    teleop_arm = next(
        (
            t
            for t in teleop
            if isinstance(
                t,
                (so100_leader.SO100Leader | so101_leader.SO101Leader | koch_leader.KochLeader),
            )
        ),
        None,
    )

    if not (teleop_arm and teleop_keyboard and len(teleop) == 2 and robot.name == &quot;lekiwi_client&quot;):
        raise ValueError(
            &quot;For multi-teleop, the list must contain exactly one KeyboardTeleop and one arm teleoperator. Currently only supported for LeKiwi robot.&quot;
        )

# Reset policy and processor if they are provided
if policy is not None and preprocessor is not None and postprocessor is not None:
    policy.reset()
    preprocessor.reset()
    postprocessor.reset()

timestamp = 0
start_episode_t = time.perf_counter()
while timestamp &lt; control_time_s:
    start_loop_t = time.perf_counter()

    if events[&quot;exit_early&quot;]:
        events[&quot;exit_early&quot;] = False
        break

    # Get robot observation
    # 获取机器人观测
    obs = robot.get_observation()

    # Applies a pipeline to the raw robot observation, default is IdentityProcessor
    # 对观测应用处理流水线（默认恒等）
    obs_processed = robot_observation_processor(obs)

    if policy is not None or dataset is not None:
        observation_frame = build_dataset_frame(dataset.features, obs_processed, prefix=OBS_STR)

    # Get action from either policy or teleop
    # 从策略或遥操作获取动作
    if policy is not None and preprocessor is not None and postprocessor is not None:
        action_values = predict_action(
            observation=observation_frame,
            policy=policy,
            device=get_safe_torch_device(policy.config.device),
            preprocessor=preprocessor,
            postprocessor=postprocessor,
            use_amp=policy.config.use_amp,
            task=single_task,
            robot_type=robot.robot_type,
        )

        act_processed_policy: RobotAction = make_robot_action(action_values, dataset.features)
    elif policy is None and isinstance(teleop, Teleoperator):
        act = teleop.get_action()

        # Applies a pipeline to the raw teleop action, default is IdentityProcessor
        # 对遥操作动作应用处理流水线（默认恒等）
        act_processed_teleop = teleop_action_processor((act, obs))

    elif policy is None and isinstance(teleop, list):
        arm_action = teleop_arm.get_action()
        arm_action = {f&quot;arm_{k}&quot;: v for k, v in arm_action.items()}
        keyboard_action = teleop_keyboard.get_action()
        base_action = robot._from_keyboard_to_base_action(keyboard_action)
        act = {**arm_action, **base_action} if len(base_action) &gt; 0 else arm_action
        act_processed_teleop = teleop_action_processor((act, obs))
    else:
        logging.info(
            &quot;No policy or teleoperator provided, skipping action generation.&quot;
            &quot;This is likely to happen when resetting the environment without a teleop device.&quot;
            &quot;The robot won't be at its rest position at the start of the next episode.&quot;
        )
        continue

    # Applies a pipeline to the action, default is IdentityProcessor
    # 对动作应用处理流水线（默认恒等）
    if policy is not None and act_processed_policy is not None:
        action_values = act_processed_policy
        robot_action_to_send = robot_action_processor((act_processed_policy, obs))
    else:
        action_values = act_processed_teleop
        robot_action_to_send = robot_action_processor((act_processed_teleop, obs))

    # Send action to robot
    # 发送动作到机器人
    # Action can eventually be clipped using `max_relative_target`,
    # 动作可能被裁剪（max_relative_target）
    # so action actually sent is saved in the dataset. action = postprocessor.process(action)
    # 实际发送的动作会存入数据集
    # TODO(steven, pepijn, adil): we should use a pipeline step to clip the action, so the sent action is the action that we input to the robot.
    # 建议在流水线中裁剪，保持一致
    _sent_action = robot.send_action(robot_action_to_send)

    # Write to dataset
    # 写入数据集
    if dataset is not None:
        action_frame = build_dataset_frame(dataset.features, action_values, prefix=ACTION)
        frame = {**observation_frame, **action_frame, &quot;task&quot;: single_task}
        dataset.add_frame(frame)

    if display_data:
        log_rerun_data(observation=obs_processed, action=action_values)

    dt_s = time.perf_counter() - start_loop_t
    busy_wait(1 / fps - dt_s)

    timestamp = time.perf_counter() - start_episode_t
</code></pre><p>@parser.wrap()
def record_web(cfg: RecordWebConfig) -> LeRobotDataset:
init_logging()
logging.info(pformat(asdict(cfg)))</p><pre><code>if cfg.display_data:
    # 使用 Web 可视化 / Use web visualization
    init_rerun_web(
        session_name=&quot;recording_web&quot;,
        port=cfg.web_port,
        open_browser=cfg.open_browser,
    )

robot = make_robot_from_config(cfg.robot)
teleop = make_teleoperator_from_config(cfg.teleop) if cfg.teleop is not None else None

teleop_action_processor, robot_action_processor, robot_observation_processor = make_default_processors()

dataset_features = combine_feature_dicts(
    aggregate_pipeline_dataset_features(
        pipeline=teleop_action_processor,
        initial_features=create_initial_features(
            action=robot.action_features
        ),  # TODO(steven, pepijn): in future this should be come from teleop or policy
        use_videos=cfg.dataset.video,
    ),
    aggregate_pipeline_dataset_features(
        pipeline=robot_observation_processor,
        initial_features=create_initial_features(observation=robot.observation_features),
        use_videos=cfg.dataset.video,
    ),
)

if cfg.resume:
    dataset = LeRobotDataset(
        cfg.dataset.repo_id,
        root=cfg.dataset.root,
        batch_encoding_size=cfg.dataset.video_encoding_batch_size,
    )

    if hasattr(robot, &quot;cameras&quot;) and len(robot.cameras) &gt; 0:
        dataset.start_image_writer(
            num_processes=cfg.dataset.num_image_writer_processes,
            num_threads=cfg.dataset.num_image_writer_threads_per_camera * len(robot.cameras),
        )
    sanity_check_dataset_robot_compatibility(dataset, robot, cfg.dataset.fps, dataset_features)
else:
    # Create empty dataset or load existing saved episodes
    sanity_check_dataset_name(cfg.dataset.repo_id, cfg.policy)
    dataset = LeRobotDataset.create(
        cfg.dataset.repo_id,
        cfg.dataset.fps,
        root=cfg.dataset.root,
        robot_type=robot.name,
        features=dataset_features,
        use_videos=cfg.dataset.video,
        image_writer_processes=cfg.dataset.num_image_writer_processes,
        image_writer_threads=cfg.dataset.num_image_writer_threads_per_camera * len(robot.cameras),
        batch_encoding_size=cfg.dataset.video_encoding_batch_size,
    )

# Load pretrained policy
policy = None if cfg.policy is None else make_policy(cfg.policy, ds_meta=dataset.meta)
preprocessor = None
postprocessor = None
if cfg.policy is not None:
    preprocessor, postprocessor = make_pre_post_processors(
        policy_cfg=cfg.policy,
        pretrained_path=cfg.policy.pretrained_path,
        dataset_stats=rename_stats(dataset.meta.stats, cfg.dataset.rename_map),
        preprocessor_overrides={
            &quot;device_processor&quot;: {&quot;device&quot;: cfg.policy.device},
            &quot;rename_observations_processor&quot;: {&quot;rename_map&quot;: cfg.dataset.rename_map},
        },
    )

robot.connect()
if teleop is not None:
    teleop.connect()

listener, events = init_keyboard_listener()

with VideoEncodingManager(dataset):
    recorded_episodes = 0
    while recorded_episodes &lt; cfg.dataset.num_episodes and not events[&quot;stop_recording&quot;]:
        log_say(f&quot;Recording episode {dataset.num_episodes}&quot;, cfg.play_sounds)
        record_loop(
            robot=robot,
            events=events,
            fps=cfg.dataset.fps,
            teleop_action_processor=teleop_action_processor,
            robot_action_processor=robot_action_processor,
            robot_observation_processor=robot_observation_processor,
            teleop=teleop,
            policy=policy,
            preprocessor=preprocessor,
            postprocessor=postprocessor,
            dataset=dataset,
            control_time_s=cfg.dataset.episode_time_s,
            single_task=cfg.dataset.single_task,
            display_data=cfg.display_data,
        )

        # Execute a few seconds without recording to give time to manually reset the environment
        # 暂停录制以便手动重置环境
        # Skip reset for the last episode to be recorded
        # 最后一个 episode 可跳过重置
        if not events[&quot;stop_recording&quot;] and (
            (recorded_episodes &lt; cfg.dataset.num_episodes - 1) or events[&quot;rerecord_episode&quot;]
        ):
            log_say(&quot;Reset the environment&quot;, cfg.play_sounds)
            record_loop(
                robot=robot,
                events=events,
                fps=cfg.dataset.fps,
                teleop_action_processor=teleop_action_processor,
                robot_action_processor=robot_action_processor,
                robot_observation_processor=robot_observation_processor,
                teleop=teleop,
                control_time_s=cfg.dataset.reset_time_s,
                single_task=cfg.dataset.single_task,
                display_data=cfg.display_data,
            )

        if events[&quot;rerecord_episode&quot;]:
            log_say(&quot;Re-record episode&quot;, cfg.play_sounds)
            events[&quot;rerecord_episode&quot;] = False
            events[&quot;exit_early&quot;] = False
            dataset.clear_episode_buffer()
            continue

        dataset.save_episode()
        recorded_episodes += 1

log_say(&quot;Stop recording&quot;, cfg.play_sounds, blocking=True)

robot.disconnect()
if teleop is not None:
    teleop.disconnect()

if not is_headless() and listener is not None:
    listener.stop()

if cfg.dataset.push_to_hub:
    dataset.push_to_hub(tags=cfg.dataset.tags, private=cfg.dataset.private)

log_say(&quot;Exiting&quot;, cfg.play_sounds)
return dataset
</code></pre><p>def main():
register_third_party_devices()
record_web()</p><p>if <strong>name</strong> == &ldquo;<strong>main</strong>&rdquo;:
main()</p><pre tabindex=0><code></code></pre></li><li><p>执行遥操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_record_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --display_data<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.repo_id<span class=o>=</span>xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.num_episodes<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.single_task<span class=o>=</span><span class=s2>&#34;Put the red pepper toy in the cardboard box&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --web_port<span class=o>=</span><span class=m>9090</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.push_to_hub<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.root<span class=o>=</span>./data/datasets/xiadengma/record-test-so101
</span></span></code></pre></div></li><li><p>运行后默认情况下会在浏览器打开<code>http://localhost:9090/?url=ws://localhost:9877</code>，可以查看机械臂和摄像头画面</p></li></ol></div></div></div><h3 class="relative group">可视化数据集<div id=可视化数据集 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%8f%af%e8%a7%86%e5%8c%96%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=锚点>#</a></span></h3><p>我们可以对录制的数据集进行可视化。</p><ul><li>查看指定回合：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-dataset-viz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --repo-id xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --root ./data/datasets/xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --episode-index <span class=m>0</span>
</span></span></code></pre></div></li><li>查看多个回合：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-dataset-viz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --repo-id xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --root ./data/datasets/xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --episodes <span class=m>0</span> <span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span>
</span></span></code></pre></div></li></ul><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-5 class=expand-toggle type=checkbox>
<label for=expand-5 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>ReRun Web 可视化</label><div class=expand-content><div class=expand-inner><ol><li><p>在<code>src/lerobot</code>下的<code>extra</code>文件夹中添加<code>lerobot_dataset_viz_web.py</code>文件，内容如下：</p><ul><li><code>lerobot_dataset_viz_web.py</code>：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>使用 Web 浏览器可视化 LeRobotDataset 中任意 episode 的所有帧数据。
</span></span></span><span class=line><span class=cl><span class=s2>Visualize data of **all** frames of any episode of a dataset of type LeRobotDataset in a web browser.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>注意 Note:
</span></span></span><span class=line><span class=cl><span class=s2>    - Episode 的最后一帧不一定对应最终状态 / The last frame doesn&#39;t always correspond to a final state
</span></span></span><span class=line><span class=cl><span class=s2>    - 图像可能存在压缩伪影 / Images may show compression artifacts from mp4 encoding
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>访问 Access:
</span></span></span><span class=line><span class=cl><span class=s2>    浏览器打开 / Open in browser: http://localhost:PORT
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>gc</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections.abc</span> <span class=kn>import</span> <span class=n>Iterator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>rerun</span> <span class=k>as</span> <span class=nn>rr</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.utils.data</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tqdm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.datasets.lerobot_dataset</span> <span class=kn>import</span> <span class=n>LeRobotDataset</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.constants</span> <span class=kn>import</span> <span class=n>ACTION</span><span class=p>,</span> <span class=n>DONE</span><span class=p>,</span> <span class=n>OBS_STATE</span><span class=p>,</span> <span class=n>REWARD</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EpisodeSampler</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用于采样单个 episode 的所有帧 / Sampler for all frames of a single episode.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>LeRobotDataset</span><span class=p>,</span> <span class=n>episode_index</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>from_idx</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>episodes</span><span class=p>[</span><span class=s2>&#34;dataset_from_index&#34;</span><span class=p>][</span><span class=n>episode_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>to_idx</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>episodes</span><span class=p>[</span><span class=s2>&#34;dataset_to_index&#34;</span><span class=p>][</span><span class=n>episode_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>frame_ids</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=n>from_idx</span><span class=p>,</span> <span class=n>to_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>iter</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>frame_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>frame_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>to_hwc_uint8_numpy</span><span class=p>(</span><span class=n>chw_float32_torch</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    将 PyTorch CHW float32 图像转换为 NumPy HWC uint8 格式。
</span></span></span><span class=line><span class=cl><span class=s2>    Convert PyTorch CHW float32 image to NumPy HWC uint8 format.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>chw_float32_torch</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>chw_float32_torch</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>chw_float32_torch</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>c</span> <span class=o>&lt;</span> <span class=n>h</span> <span class=ow>and</span> <span class=n>c</span> <span class=o>&lt;</span> <span class=n>w</span><span class=p>,</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;期望通道优先格式，但得到 / expect channel first images, but got </span><span class=si>{</span><span class=n>chw_float32_torch</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hwc_uint8_numpy</span> <span class=o>=</span> <span class=p>(</span><span class=n>chw_float32_torch</span> <span class=o>*</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>type</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span><span class=o>.</span><span class=n>permute</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hwc_uint8_numpy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_episode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span><span class=p>:</span> <span class=n>LeRobotDataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>episode_index</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_workers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    在 Rerun 中可视化单个 episode 的所有帧。
</span></span></span><span class=line><span class=cl><span class=s2>    Visualize all frames of a single episode in Rerun.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        dataset: LeRobot 数据集 / LeRobot dataset
</span></span></span><span class=line><span class=cl><span class=s2>        episode_index: Episode 索引 / Episode index
</span></span></span><span class=line><span class=cl><span class=s2>        batch_size: 批处理大小 / Batch size for dataloader
</span></span></span><span class=line><span class=cl><span class=s2>        num_workers: 数据加载进程数 / Number of worker processes
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;📊 加载 Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2> 的数据加载器 / Loading dataloader for Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>episode_sampler</span> <span class=o>=</span> <span class=n>EpisodeSampler</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span> <span class=n>episode_index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dataloader</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>DataLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=n>num_workers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span><span class=o>=</span><span class=n>episode_sampler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_frames</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>episode_sampler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;📈 Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2> 共有 </span><span class=si>{</span><span class=n>total_frames</span><span class=si>}</span><span class=s2> 帧 / Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2> has </span><span class=si>{</span><span class=n>total_frames</span><span class=si>}</span><span class=s2> frames&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 记录数据到 Rerun / Log data to Rerun</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=o>.</span><span class=n>tqdm</span><span class=p>(</span><span class=n>dataloader</span><span class=p>,</span> <span class=n>total</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>dataloader</span><span class=p>),</span> <span class=n>desc</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 遍历批次中的每一帧 / iterate over the batch</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=s2>&#34;index&#34;</span><span class=p>])):</span>
</span></span><span class=line><span class=cl>            <span class=n>rr</span><span class=o>.</span><span class=n>set_time_sequence</span><span class=p>(</span><span class=s2>&#34;frame_index&#34;</span><span class=p>,</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&#34;frame_index&#34;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>rr</span><span class=o>.</span><span class=n>set_time_seconds</span><span class=p>(</span><span class=s2>&#34;timestamp&#34;</span><span class=p>,</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&#34;timestamp&#34;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示相机图像 / display camera images</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>camera_keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;cameras/</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>to_hwc_uint8_numpy</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=n>key</span><span class=p>][</span><span class=n>i</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示动作空间的每个维度 / display each dimension of action space</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>ACTION</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>dim_idx</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=n>ACTION</span><span class=p>][</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                    <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>ACTION</span><span class=si>}</span><span class=s2>/dim_</span><span class=si>{</span><span class=n>dim_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=n>val</span><span class=o>.</span><span class=n>item</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示观测状态空间的每个维度 / display each dimension of observed state space</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>OBS_STATE</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>dim_idx</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=n>OBS_STATE</span><span class=p>][</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                    <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;state/dim_</span><span class=si>{</span><span class=n>dim_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=n>val</span><span class=o>.</span><span class=n>item</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示完成标志 / display done flag</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>DONE</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>DONE</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=n>DONE</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示奖励 / display reward</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>REWARD</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>REWARD</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=n>REWARD</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 显示成功标志 / display success flag</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;next.success&#34;</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>Scalar</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=s2>&#34;next.success&#34;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2> 可视化完成 / Episode </span><span class=si>{</span><span class=n>episode_index</span><span class=si>}</span><span class=s2> visualization complete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_dataset_web</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span><span class=p>:</span> <span class=n>LeRobotDataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>episode_indices</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_workers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>9090</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>open_browser</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_limit</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;25%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    使用 Web 界面可视化数据集。
</span></span></span><span class=line><span class=cl><span class=s2>    Visualize dataset using web interface.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        dataset: LeRobot 数据集 / LeRobot dataset
</span></span></span><span class=line><span class=cl><span class=s2>        episode_indices: 要可视化的 episode 索引列表 / List of episode indices to visualize
</span></span></span><span class=line><span class=cl><span class=s2>        batch_size: 批处理大小 / Batch size for dataloader
</span></span></span><span class=line><span class=cl><span class=s2>        num_workers: 数据加载进程数 / Number of worker processes
</span></span></span><span class=line><span class=cl><span class=s2>        port: Web 服务器端口 / Web server port
</span></span></span><span class=line><span class=cl><span class=s2>        open_browser: 是否自动打开浏览器 / Whether to automatically open browser
</span></span></span><span class=line><span class=cl><span class=s2>        memory_limit: Rerun 内存限制 / Memory limit for Rerun
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>repo_id</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>repo_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化 Rerun Web 界面 / Initialize Rerun web interface</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🌐 启动 Rerun Web 界面 / Starting Rerun Web interface&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📍 访问地址 / Access URL: http://localhost:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;💾 内存限制 / Memory limit: </span><span class=si>{</span><span class=n>memory_limit</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>repo_id</span><span class=si>}</span><span class=s2>_web_viz&#34;</span><span class=p>,</span> <span class=n>spawn</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 手动触发垃圾回收，避免阻塞 / Manually call garbage collector to avoid blocking</span>
</span></span><span class=line><span class=cl>    <span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 启动 Web 服务器 / Start web server</span>
</span></span><span class=line><span class=cl>    <span class=n>rr</span><span class=o>.</span><span class=n>serve_web</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>open_browser</span><span class=o>=</span><span class=n>open_browser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>web_port</span><span class=o>=</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>server_memory_limit</span><span class=o>=</span><span class=n>memory_limit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 可视化每个 episode / Visualize each episode</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>episode_idx</span> <span class=ow>in</span> <span class=n>episode_indices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>episode_idx</span> <span class=o>&gt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>episodes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;⚠️  Episode </span><span class=si>{</span><span class=n>episode_idx</span><span class=si>}</span><span class=s2> 不存在，跳过 / Episode </span><span class=si>{</span><span class=n>episode_idx</span><span class=si>}</span><span class=s2> does not exist, skipping&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 为每个 episode 创建记录路径 / Create recording path for each episode</span>
</span></span><span class=line><span class=cl>        <span class=n>rr</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;episode_</span><span class=si>{</span><span class=n>episode_idx</span><span class=si>}</span><span class=s2>/info&#34;</span><span class=p>,</span> <span class=n>rr</span><span class=o>.</span><span class=n>TextLog</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Episode </span><span class=si>{</span><span class=n>episode_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>),</span> <span class=n>static</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 设置时间序列标记当前 episode / Set time sequence for current episode</span>
</span></span><span class=line><span class=cl>        <span class=n>rr</span><span class=o>.</span><span class=n>set_time_sequence</span><span class=p>(</span><span class=s2>&#34;episode&#34;</span><span class=p>,</span> <span class=n>episode_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>visualize_episode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>dataset</span><span class=o>=</span><span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>episode_index</span><span class=o>=</span><span class=n>episode_idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>num_workers</span><span class=o>=</span><span class=n>num_workers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✨ 所有 episode 可视化完成 / All episodes visualization complete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🌐 Web 服务器持续运行中，按 Ctrl+C 退出 / Web server running, press Ctrl+C to exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 保持服务器运行 / Keep server running</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;👋 收到 Ctrl-C，正在退出 / Ctrl-C received, exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;使用 Web 浏览器可视化 LeRobot 数据集 / Visualize LeRobot dataset in web browser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>formatter_class</span><span class=o>=</span><span class=n>argparse</span><span class=o>.</span><span class=n>RawDescriptionHelpFormatter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--repo-id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;数据集仓库 ID / Dataset repository ID (e.g. `lerobot/pusht` or `xiadengma/record-test-so101`)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Episode 选择参数 / Episode selection arguments</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>add_mutually_exclusive_group</span><span class=p>(</span><span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--episode-index&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;要可视化的单个 episode 索引 / Single episode index to visualize&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--episodes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>nargs</span><span class=o>=</span><span class=s2>&#34;+&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;要可视化的多个 episode 索引 / Multiple episode indices to visualize (e.g. 0 1 2 3)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=n>Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;本地数据集根目录 / Root directory for local dataset (e.g. `--root ./data/datasets/xiadengma/record-test-so101`)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--batch-size&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;DataLoader 批处理大小 / Batch size for DataLoader (default: 32)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--num-workers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;DataLoader 进程数 / Number of DataLoader worker processes (default: 4)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--port&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=mi>9090</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Web 服务器端口 / Web server port (default: 9090)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--open-browser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;true&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;yes&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;是否自动打开浏览器 / Whether to automatically open browser (default: True)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--memory-limit&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;25%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Rerun 内存限制 / Memory limit for Rerun (default: 25</span><span class=si>%%</span><span class=s2>)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--tolerance-s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=mf>1e-4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;时间戳容差（秒）/ Tolerance in seconds for timestamps (default: 1e-4)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 配置日志 / Configure logging</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>format</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>%(asctime)s</span><span class=s2> - </span><span class=si>%(levelname)s</span><span class=s2> - </span><span class=si>%(message)s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>datefmt</span><span class=o>=</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2> %H:%M:%S&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 确定要可视化的 episode 列表 / Determine episode list</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>episode_index</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>episode_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>args</span><span class=o>.</span><span class=n>episode_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>episode_indices</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>episodes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🤖 LeRobot 数据集 Web 可视化工具 / LeRobot Dataset Web Visualizer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📦 数据集 / Dataset: </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>repo_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📂 根目录 / Root: </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>root</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>root</span> <span class=k>else</span> <span class=s1>&#39;HuggingFace Cache&#39;</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📊 Episodes: </span><span class=si>{</span><span class=n>episode_indices</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 加载数据集 / Load dataset</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🔄 正在加载数据集 / Loading dataset...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>LeRobotDataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>repo_id</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>repo_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>episodes</span><span class=o>=</span><span class=n>episode_indices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>root</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>root</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tolerance_s</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>tolerance_s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✅ 数据集加载成功 / Dataset loaded successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📈 数据集总帧数 / Total frames: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📹 相机数量 / Number of cameras: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>camera_keys</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;🎥 相机列表 / Camera keys: </span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>camera_keys</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 启动 Web 可视化 / Start web visualization</span>
</span></span><span class=line><span class=cl>    <span class=n>visualize_dataset_web</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=o>=</span><span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>episode_indices</span><span class=o>=</span><span class=n>episode_indices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>num_workers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>open_browser</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>open_browser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>memory_limit</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>memory_limit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div></li><li><p>查看数据集：</p><ul><li>查看单个回合：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_dataset_viz_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--repo-id xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--root ./data/datasets/xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--episode-index <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--port <span class=m>9090</span>
</span></span></code></pre></div></li><li>查看多个回合：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_dataset_viz_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--repo-id xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--root ./data/datasets/xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--episodes <span class=m>0</span> <span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--port <span class=m>9090</span>
</span></span></code></pre></div></li></ul></li></ol></div></div></div><h3 class="relative group">回放数据集<div id=回放数据集 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%9b%9e%e6%94%be%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=锚点>#</a></span></h3><blockquote class="book-hint info"><div class=hint-content>不稳定，可跳过，可尝试。</div></blockquote><p>你也可以让机械臂根据数据集进行回放：</p><ol><li>回放之前测试录制数据集的第一个回合：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lerobot-replay <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --dataset.repo_id<span class=o>=</span>xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --dataset.root<span class=o>=</span>./data/datasets/xiadengma/record-test-so101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --dataset.episode<span class=o>=</span><span class=m>0</span>
</span></span></code></pre></div></li><li>你应该可以看到机械臂按照数据集进行回放。</li></ol><h3 class="relative group">录制完整数据集<div id=录制完整数据集 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%bd%95%e5%88%b6%e5%ae%8c%e6%95%b4%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=锚点>#</a></span></h3><p>现在，我们开始录制数据集，并将这个数据集训练后用于推理。</p><ul><li>每个回合录制流程：等待程序提示录制当前回合，通过主臂遥操作机械臂进行抓取，抓取结束后，将机械臂恢复到休息位再结束当前回合，等待程序记录数据的同时重置抓取环境，等待程序提示录制下一个回合。</li><li>录制要求：<ol><li>录制数量：至少 50 组数据，确保数据充分性</li><li>录制频次：每个位置重复录制 10 次，以提高数据的多样性和鲁棒性</li><li>录制位置：至少选择 5 个不同的位置，涵盖更多动作场景</li></ol></li><li>键盘控制说明：<table><thead><tr><th>按键</th><th>何时使用</th><th>作用</th></tr></thead><tbody><tr><td>右箭头 (→)</td><td>在当前回合采集期间，并且你已成功完成任务</td><td>成功并提前结束 当前 回合，保存数据，然后进入重置阶段。</td></tr><tr><td>左箭头 (←)</td><td>在当前回合采集期间，但你犯了个错误</td><td>作废并重新开始 当前 回合。这次的录制数据会被丢弃。</td></tr><tr><td>ESC 键</td><td>任何时候</td><td>完全终止 整个采集会话。程序会保存已完成的数据并退出。</td></tr></tbody></table></li></ul><ol><li><p>录制数据集：</p><ul><li>采集次数：50 次</li><li>采集任务（请自定义修改）：<code>Put the red pepper toy in the cardboard box</code></li><li>采集数据保存路径（请自定义修改）：<code>./data/datasets/xiadengma/so101-red-pepper</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_record_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --display_data<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.repo_id<span class=o>=</span>xiadengma/so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.num_episodes<span class=o>=</span><span class=m>50</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.single_task<span class=o>=</span><span class=s2>&#34;Put the red pepper toy in the cardboard box&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --web_port<span class=o>=</span><span class=m>9090</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.push_to_hub<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.root<span class=o>=</span>./data/datasets/xiadengma/so101-red-pepper
</span></span></code></pre></div></li><li><p>恢复录制（仅供参考）：</p><ol><li><p><code>Recording episode 15</code>时程序报错：<code>Waiting for image writer to terminate...</code>和<code>TimeoutError: Timed out waiting for frame from camera OpenCVCamera(8) after 200 ms. Read thread alive: True.</code></p><ul><li><p>问题原因：在机械臂运动过程中，拉扯到机械臂腕部摄像头的连接处，导致摄像头连接不稳定。</p></li><li><p>解决方法：重新连接摄像头，并预留足够长度的线缆，确保摄像头连接稳定，接着运行下面命令恢复录制。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -m lerobot.extra.lerobot_record_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.type<span class=o>=</span>so101_leader <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.port<span class=o>=</span>/dev/leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.id<span class=o>=</span>my_leader_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --teleop.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --display_data<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.repo_id<span class=o>=</span>xiadengma/so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.num_episodes<span class=o>=</span><span class=m>35</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.single_task<span class=o>=</span><span class=s2>&#34;Put the red pepper toy in the cardboard box&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --web_port<span class=o>=</span><span class=m>9090</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.push_to_hub<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --dataset.root<span class=o>=</span>./data/datasets/xiadengma/so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      --resume<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><ul><li>在记录过程中会自动创建检查点。</li><li>如果记录过程中断，可以通过重新运行相同的命令并添加 &ndash;resume=true 来恢复记录。</li><li>⚠️ 重要提示：在恢复时，需将 &ndash;dataset.num_episodes 设置为要额外记录的剧集数量（而不是数据集中目标的总剧集数量）</li></ul><p>录制结束后，数据集大小为<code>390M</code></p></li></ul></li></ol></li></ol><h2 class="relative group">训练<div id=训练 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e8%ae%ad%e7%bb%83 aria-label=锚点>#</a></span></h2><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-7 class=expand-toggle type=checkbox>
<label for=expand-7 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>如果使用SwanLab训练，必须修改，官方暂时没有合并分支</label><div class=expand-content><div class=expand-inner><p>在<code>extra</code>文件夹添加<code>swanlab_utils.py</code>、<code>train_swanlab.py</code>和<code>lerobot_train_swanlab.py</code>。</p><ul><li><p><code>swanlab_utils.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>glob</span> <span class=kn>import</span> <span class=n>glob</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>TYPE_CHECKING</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>huggingface_hub.constants</span> <span class=kn>import</span> <span class=n>SAFETENSORS_SINGLE_FILE</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>termcolor</span> <span class=kn>import</span> <span class=n>colored</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.constants</span> <span class=kn>import</span> <span class=n>PRETRAINED_MODEL_DIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>TYPE_CHECKING</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>lerobot.extra.train_swanlab</span> <span class=kn>import</span> <span class=n>TrainPipelineSwanLabConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cfg_to_group</span><span class=p>(</span><span class=n>cfg</span><span class=p>:</span> <span class=s2>&#34;TrainPipelineSwanLabConfig&#34;</span><span class=p>,</span> <span class=n>return_list</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Return a group name for logging. Optionally returns group name as list.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>lst</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;policy:</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>type</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;seed:</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>seed</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>dataset</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;dataset:</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>dataset</span><span class=o>.</span><span class=n>repo_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;env:</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>env</span><span class=o>.</span><span class=n>type</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lst</span> <span class=k>if</span> <span class=n>return_list</span> <span class=k>else</span> <span class=s2>&#34;-&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>lst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_swanlab_run_id_from_filesystem</span><span class=p>(</span><span class=n>log_dir</span><span class=p>:</span> <span class=n>Path</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Get the SwanLab run ID.</span>
</span></span><span class=line><span class=cl>    <span class=n>paths</span> <span class=o>=</span> <span class=n>glob</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>log_dir</span> <span class=o>/</span> <span class=s2>&#34;swanlab/latest-run/run-*&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>paths</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Couldn&#39;t get the previous SwanLab run ID for run resumption.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;run-([^\.]+).swanlab&#34;</span><span class=p>,</span> <span class=n>paths</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Couldn&#39;t get the previous SwanLab run ID for run resumption.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>swanlab_run_id</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>groups</span><span class=p>(</span><span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>swanlab_run_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_safe_swanlab_artifact_name</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;SwanLab artifacts don&#39;t accept &#34;:&#34; or &#34;/&#34; in their name.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>name</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SwanLabLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A helper class to log object using swanlab.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cfg</span><span class=p>:</span> <span class=s2>&#34;TrainPipelineSwanLabConfig&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>swanlab</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log_dir</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>output_dir</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>job_name</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>job_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>env_fps</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span><span class=o>.</span><span class=n>fps</span> <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_group</span> <span class=o>=</span> <span class=n>cfg_to_group</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>swanlab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>swanlab_run_id</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>cfg</span><span class=o>.</span><span class=n>swanlab</span><span class=o>.</span><span class=n>run_id</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>swanlab</span><span class=o>.</span><span class=n>run_id</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=n>get_swanlab_run_id_from_filesystem</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>log_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>resume</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_run</span> <span class=o>=</span> <span class=n>swanlab</span><span class=o>.</span><span class=n>init</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>project</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>experiment_name</span><span class=o>=</span><span class=n>swanlab_run_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>notes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tags</span><span class=o>=</span><span class=n>cfg_to_group</span><span class=p>(</span><span class=n>cfg</span><span class=p>,</span> <span class=n>return_list</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>logdir</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>log_dir</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>config</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>save_code</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>resume</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>resume</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mode</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>mode</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>mode</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;cloud&#34;</span><span class=p>,</span> <span class=s2>&#34;offline&#34;</span><span class=p>,</span> <span class=s2>&#34;local&#34;</span><span class=p>,</span> <span class=s2>&#34;disabled&#34;</span><span class=p>]</span> <span class=k>else</span> <span class=s2>&#34;cloud&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>run_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_run</span><span class=o>.</span><span class=n>public</span><span class=o>.</span><span class=n>run_id</span>
</span></span><span class=line><span class=cl>        <span class=c1># NOTE: We will override the cfg.swanlab.run_id with the swanlab run id.</span>
</span></span><span class=line><span class=cl>        <span class=c1># This is because we want to be able to resume the run from the swanlab run id.</span>
</span></span><span class=line><span class=cl>        <span class=n>cfg</span><span class=o>.</span><span class=n>swanlab</span><span class=o>.</span><span class=n>run_id</span> <span class=o>=</span> <span class=n>run_id</span>
</span></span><span class=line><span class=cl>        <span class=c1># Handle custom step key for rl asynchronous training.</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span><span class=p>:</span> <span class=nb>set</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;Logs will be synced with swanlab.&#34;</span><span class=p>,</span> <span class=s2>&#34;blue&#34;</span><span class=p>,</span> <span class=n>attrs</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;bold&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;Track this run --&gt; </span><span class=si>{</span><span class=n>colored</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_run</span><span class=o>.</span><span class=n>public</span><span class=o>.</span><span class=n>cloud</span><span class=o>.</span><span class=n>experiment_url</span><span class=p>,</span> <span class=s1>&#39;yellow&#39;</span><span class=p>,</span> <span class=n>attrs</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;bold&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span> <span class=o>=</span> <span class=n>swanlab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_policy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>checkpoint_dir</span><span class=p>:</span> <span class=n>Path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Checkpoints the policy to swanlab.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>disable_artifact</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>step_id</span> <span class=o>=</span> <span class=n>checkpoint_dir</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=n>artifact_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_group</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>step_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>artifact_name</span> <span class=o>=</span> <span class=n>get_safe_swanlab_artifact_name</span><span class=p>(</span><span class=n>artifact_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># SwanLab doesn&#39;t have direct artifact logging like wandb</span>
</span></span><span class=line><span class=cl>        <span class=c1># We&#39;ll log the model file path as a text log for now</span>
</span></span><span class=line><span class=cl>        <span class=n>model_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>checkpoint_dir</span> <span class=o>/</span> <span class=n>PRETRAINED_MODEL_DIR</span> <span class=o>/</span> <span class=n>SAFETENSORS_SINGLE_FILE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>log</span><span class=p>({</span><span class=s2>&#34;model_checkpoint&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>Text</span><span class=p>(</span><span class=n>model_path</span><span class=p>)},</span> <span class=n>step</span><span class=o>=</span><span class=n>step_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_dict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span> <span class=n>d</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>mode</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;train&#34;</span><span class=p>,</span> <span class=n>custom_step_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>mode</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>{</span><span class=s2>&#34;train&#34;</span><span class=p>,</span> <span class=s2>&#34;eval&#34;</span><span class=p>}:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>step</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>custom_step_key</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Either step or custom_step_key must be provided.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># NOTE: This is not simple. SwanLab step must always monotonically increase and it</span>
</span></span><span class=line><span class=cl>        <span class=c1># increases with each swanlab.log call, but in the case of asynchronous RL for example,</span>
</span></span><span class=line><span class=cl>        <span class=c1># multiple time steps is possible. For example, the interaction step with the environment,</span>
</span></span><span class=line><span class=cl>        <span class=c1># the training step, the evaluation step, etc. So we need to define a custom step key</span>
</span></span><span class=line><span class=cl>        <span class=c1># to log the correct step for each metric.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>custom_step_key</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>new_custom_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>mode</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>custom_step_key</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>new_custom_key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>new_custom_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>d</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>str</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=sa>f</span><span class=s1>&#39;SwanLab logging of key &#34;</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s1>&#34; was ignored as its type &#34;</span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=si>}</span><span class=s1>&#34; is not handled by this wrapper.&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Do not log the custom step key itself.</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>k</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab_custom_step_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>custom_step_key</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>value_custom_step</span> <span class=o>=</span> <span class=n>d</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>custom_step_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>value_custom_step</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=sa>f</span><span class=s1>&#39;Custom step key &#34;</span><span class=si>{</span><span class=n>custom_step_key</span><span class=si>}</span><span class=s1>&#34; not found in the dictionary. Skipping logging for this key.&#39;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>mode</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=n>v</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>mode</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>custom_step_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=n>value_custom_step</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>mode</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=n>v</span><span class=p>},</span> <span class=n>step</span><span class=o>=</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_video</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>video_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>mode</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;train&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>mode</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>{</span><span class=s2>&#34;train&#34;</span><span class=p>,</span> <span class=s2>&#34;eval&#34;</span><span class=p>}:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># SwanLab media logging - using Media.Video for video logging</span>
</span></span><span class=line><span class=cl>        <span class=n>swanlab_video</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>Video</span><span class=p>(</span><span class=n>video_path</span><span class=p>,</span> <span class=n>fps</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>env_fps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_swanlab</span><span class=o>.</span><span class=n>log</span><span class=p>({</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>mode</span><span class=si>}</span><span class=s2>/video&#34;</span><span class=p>:</span> <span class=n>swanlab_video</span><span class=p>},</span> <span class=n>step</span><span class=o>=</span><span class=n>step</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p><code>train_swanlab.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>SwanLab 训练配置扩展 - 扩展 TrainPipelineConfig 以支持 SwanLab
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>这个模块为 LeRobot 训练管道提供 SwanLab 日志记录支持。
</span></span></span><span class=line><span class=cl><span class=s2>它继承了原始的 TrainPipelineConfig，并添加了 tracker 和 swanlab 配置字段。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.configs.train</span> <span class=kn>import</span> <span class=n>TrainPipelineConfig</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.extra.default_swanlab</span> <span class=kn>import</span> <span class=n>SwanLabConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TrainPipelineSwanLabConfig</span><span class=p>(</span><span class=n>TrainPipelineConfig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;支持 SwanLab 的训练管道配置
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    继承自 TrainPipelineConfig，添加了以下字段：
</span></span></span><span class=line><span class=cl><span class=s2>        tracker: 日志跟踪器选择，可选值: &#39;wandb&#39;, &#39;swanlab&#39;, &#39;both&#39;, &#39;none&#39;
</span></span></span><span class=line><span class=cl><span class=s2>        swanlab: SwanLab 配置对象
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用示例：
</span></span></span><span class=line><span class=cl><span class=s2>        ```python
</span></span></span><span class=line><span class=cl><span class=s2>        config = TrainPipelineSwanLabConfig(
</span></span></span><span class=line><span class=cl><span class=s2>            dataset=DatasetConfig(repo_id=&#34;my/dataset&#34;),
</span></span></span><span class=line><span class=cl><span class=s2>            tracker=&#34;swanlab&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>            swanlab=SwanLabConfig(project=&#34;my-project&#34;, mode=&#34;cloud&#34;),
</span></span></span><span class=line><span class=cl><span class=s2>        )
</span></span></span><span class=line><span class=cl><span class=s2>        ```
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Tracker selection: &#39;wandb&#39;, &#39;swanlab&#39;, &#39;both&#39;, or &#39;none&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 跟踪器选择: &#39;wandb&#39;, &#39;swanlab&#39;, &#39;both&#39;, 或 &#39;none&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>tracker</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;wandb&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># SwanLab configuration</span>
</span></span><span class=line><span class=cl>    <span class=c1># SwanLab 配置</span>
</span></span><span class=line><span class=cl>    <span class=n>swanlab</span><span class=p>:</span> <span class=n>SwanLabConfig</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=n>SwanLabConfig</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p><code>lerobot_train_swanlab.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2024 The HuggingFace Inc. team. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练脚本：构建数据集/环境/策略与优化器，执行训练循环并定期评估与保存</span>
</span></span><span class=line><span class=cl><span class=c1>#   --tracker=swanlab \</span>
</span></span><span class=line><span class=cl><span class=c1>#   --swanlab.project=my_lerobot \</span>
</span></span><span class=line><span class=cl><span class=c1>#   --swanlab.mode=cloud</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>nullcontext</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pprint</span> <span class=kn>import</span> <span class=n>pformat</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>termcolor</span> <span class=kn>import</span> <span class=n>colored</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.amp</span> <span class=kn>import</span> <span class=n>GradScaler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.optim</span> <span class=kn>import</span> <span class=n>Optimizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.configs</span> <span class=kn>import</span> <span class=n>parser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.datasets.factory</span> <span class=kn>import</span> <span class=n>make_dataset</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.datasets.sampler</span> <span class=kn>import</span> <span class=n>EpisodeAwareSampler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.datasets.utils</span> <span class=kn>import</span> <span class=n>cycle</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.envs.factory</span> <span class=kn>import</span> <span class=n>make_env</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.envs.utils</span> <span class=kn>import</span> <span class=n>close_envs</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.extra.swanlab_utils</span> <span class=kn>import</span> <span class=n>SwanLabLogger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.extra.train_swanlab</span> <span class=kn>import</span> <span class=n>TrainPipelineSwanLabConfig</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.optim.factory</span> <span class=kn>import</span> <span class=n>make_optimizer_and_scheduler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.policies.factory</span> <span class=kn>import</span> <span class=n>make_policy</span><span class=p>,</span> <span class=n>make_pre_post_processors</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.policies.pretrained</span> <span class=kn>import</span> <span class=n>PreTrainedPolicy</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.policies.utils</span> <span class=kn>import</span> <span class=n>get_device_from_parameters</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.rl.wandb_utils</span> <span class=kn>import</span> <span class=n>WandBLogger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.scripts.lerobot_eval</span> <span class=kn>import</span> <span class=n>eval_policy_all</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.logging_utils</span> <span class=kn>import</span> <span class=n>AverageMeter</span><span class=p>,</span> <span class=n>MetricsTracker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.random_utils</span> <span class=kn>import</span> <span class=n>set_seed</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.train_utils</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>get_step_checkpoint_dir</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>get_step_identifier</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>load_training_state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>save_checkpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>update_last_checkpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lerobot.utils.utils</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>format_big_number</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>get_safe_torch_device</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>has_method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>init_logging</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_policy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span><span class=p>:</span> <span class=n>MetricsTracker</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>policy</span><span class=p>:</span> <span class=n>PreTrainedPolicy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>batch</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=p>:</span> <span class=n>Optimizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_clip_norm</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scaler</span><span class=p>:</span> <span class=n>GradScaler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>lr_scheduler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>use_amp</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>MetricsTracker</span><span class=p>,</span> <span class=nb>dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Performs a single training step to update the policy&#39;s weights.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    This function executes the forward and backward passes, clips gradients, and steps the optimizer and
</span></span></span><span class=line><span class=cl><span class=s2>    learning rate scheduler. It also handles mixed-precision training via a GradScaler.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        train_metrics: A MetricsTracker instance to record training statistics.
</span></span></span><span class=line><span class=cl><span class=s2>        policy: The policy model to be trained.
</span></span></span><span class=line><span class=cl><span class=s2>        batch: A batch of training data.
</span></span></span><span class=line><span class=cl><span class=s2>        optimizer: The optimizer used to update the policy&#39;s parameters.
</span></span></span><span class=line><span class=cl><span class=s2>        grad_clip_norm: The maximum norm for gradient clipping.
</span></span></span><span class=line><span class=cl><span class=s2>        grad_scaler: The GradScaler for automatic mixed-precision training.
</span></span></span><span class=line><span class=cl><span class=s2>        lr_scheduler: An optional learning rate scheduler.
</span></span></span><span class=line><span class=cl><span class=s2>        use_amp: A boolean indicating whether to use automatic mixed precision.
</span></span></span><span class=line><span class=cl><span class=s2>        lock: An optional lock for thread-safe optimizer updates.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        A tuple containing:
</span></span></span><span class=line><span class=cl><span class=s2>        - The updated MetricsTracker with new statistics for this step.
</span></span></span><span class=line><span class=cl><span class=s2>        - A dictionary of outputs from the policy&#39;s forward pass, for logging purposes.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>device</span> <span class=o>=</span> <span class=n>get_device_from_parameters</span><span class=p>(</span><span class=n>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>policy</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=n>device_type</span><span class=o>=</span><span class=n>device</span><span class=o>.</span><span class=n>type</span><span class=p>)</span> <span class=k>if</span> <span class=n>use_amp</span> <span class=k>else</span> <span class=n>nullcontext</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span><span class=p>,</span> <span class=n>output_dict</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO(rcadene): policy.unnormalize_outputs(out_dict)</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scaler</span><span class=o>.</span><span class=n>scale</span><span class=p>(</span><span class=n>loss</span><span class=p>)</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Unscale the gradient of the optimizer&#39;s assigned params in-place **prior to gradient clipping**.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 在裁剪梯度之前反缩放优化器参数的梯度</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scaler</span><span class=o>.</span><span class=n>unscale_</span><span class=p>(</span><span class=n>optimizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>grad_norm</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>clip_grad_norm_</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>policy</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>grad_clip_norm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>error_if_nonfinite</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Optimizer&#39;s gradients are already unscaled, so scaler.step does not unscale them,</span>
</span></span><span class=line><span class=cl>    <span class=c1># 优化器梯度已反缩放，scaler.step 不再反缩放</span>
</span></span><span class=line><span class=cl>    <span class=c1># although it still skips optimizer.step() if the gradients contain infs or NaNs.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 若梯度含 inf/NaN，会跳过 optimizer.step()</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>lock</span> <span class=k>if</span> <span class=n>lock</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>nullcontext</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>grad_scaler</span><span class=o>.</span><span class=n>step</span><span class=p>(</span><span class=n>optimizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Updates the scale for next iteration.</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scaler</span><span class=o>.</span><span class=n>update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step through pytorch scheduler at every batch instead of epoch</span>
</span></span><span class=line><span class=cl>    <span class=c1># 每个 batch 调度学习率而非每个 epoch</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>lr_scheduler</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lr_scheduler</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>has_method</span><span class=p>(</span><span class=n>policy</span><span class=p>,</span> <span class=s2>&#34;update&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># To possibly update an internal buffer (for instance an Exponential Moving Average like in TDMPC).</span>
</span></span><span class=line><span class=cl>        <span class=n>policy</span><span class=o>.</span><span class=n>update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span><span class=o>.</span><span class=n>loss</span> <span class=o>=</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span><span class=o>.</span><span class=n>grad_norm</span> <span class=o>=</span> <span class=n>grad_norm</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span><span class=o>.</span><span class=n>lr</span> <span class=o>=</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>param_groups</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;lr&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span><span class=o>.</span><span class=n>update_s</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>train_metrics</span><span class=p>,</span> <span class=n>output_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@parser.wrap</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>train</span><span class=p>(</span><span class=n>cfg</span><span class=p>:</span> <span class=n>TrainPipelineSwanLabConfig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Main function to train a policy with SwanLab support.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    This function orchestrates the entire training pipeline, including:
</span></span></span><span class=line><span class=cl><span class=s2>    - Setting up logging, seeding, and device configuration.
</span></span></span><span class=line><span class=cl><span class=s2>    - Creating the dataset, evaluation environment (if applicable), policy, and optimizer.
</span></span></span><span class=line><span class=cl><span class=s2>    - Handling resumption from a checkpoint.
</span></span></span><span class=line><span class=cl><span class=s2>    - Running the main training loop, which involves fetching data batches and calling `update_policy`.
</span></span></span><span class=line><span class=cl><span class=s2>    - Periodically logging metrics, saving model checkpoints, and evaluating the policy.
</span></span></span><span class=line><span class=cl><span class=s2>    - Pushing the final trained model to the Hugging Face Hub if configured.
</span></span></span><span class=line><span class=cl><span class=s2>    - Supporting both WandB and SwanLab for experiment tracking.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        cfg: A `TrainPipelineSwanLabConfig` object containing all training configurations.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cfg</span><span class=o>.</span><span class=n>validate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>pformat</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialize loggers based on tracker selection</span>
</span></span><span class=line><span class=cl>    <span class=n>wandb_logger</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>swanlab_logger</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>tracker</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;wandb&#34;</span><span class=p>,</span> <span class=s2>&#34;both&#34;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>cfg</span><span class=o>.</span><span class=n>wandb</span><span class=o>.</span><span class=n>project</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>wandb_logger</span> <span class=o>=</span> <span class=n>WandBLogger</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>tracker</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;swanlab&#34;</span><span class=p>,</span> <span class=s2>&#34;both&#34;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>cfg</span><span class=o>.</span><span class=n>swanlab</span><span class=o>.</span><span class=n>project</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>swanlab_logger</span> <span class=o>=</span> <span class=n>SwanLabLogger</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>tracker</span> <span class=o>==</span> <span class=s2>&#34;none&#34;</span> <span class=ow>or</span> <span class=p>(</span><span class=ow>not</span> <span class=n>wandb_logger</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>swanlab_logger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;Logs will be saved locally.&#34;</span><span class=p>,</span> <span class=s2>&#34;yellow&#34;</span><span class=p>,</span> <span class=n>attrs</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;bold&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>seed</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>set_seed</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>seed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check device is available</span>
</span></span><span class=line><span class=cl>    <span class=n>device</span> <span class=o>=</span> <span class=n>get_safe_torch_device</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>device</span><span class=p>,</span> <span class=n>log</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>cudnn</span><span class=o>.</span><span class=n>benchmark</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>matmul</span><span class=o>.</span><span class=n>allow_tf32</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Creating dataset&#34;</span><span class=p>)</span>  <span class=c1># 正在创建数据集</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>make_dataset</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create environment used for evaluating checkpoints during training on simulation data.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 用于在仿真训练中评估检查点</span>
</span></span><span class=line><span class=cl>    <span class=c1># On real-world data, no need to create an environment as evaluations are done outside train.py,</span>
</span></span><span class=line><span class=cl>    <span class=c1># 真实数据上评估在 train.py 外进行</span>
</span></span><span class=line><span class=cl>    <span class=c1># using the eval.py instead, with gym_dora environment and dora-rs.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用 eval.py 与 gym_dora/dora-rs</span>
</span></span><span class=line><span class=cl>    <span class=n>eval_env</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>eval_freq</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Creating env&#34;</span><span class=p>)</span>  <span class=c1># 正在创建环境</span>
</span></span><span class=line><span class=cl>        <span class=n>eval_env</span> <span class=o>=</span> <span class=n>make_env</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>env</span><span class=p>,</span> <span class=n>n_envs</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>eval</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>use_async_envs</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>eval</span><span class=o>.</span><span class=n>use_async_envs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Creating policy&#34;</span><span class=p>)</span>  <span class=c1># 正在创建策略</span>
</span></span><span class=line><span class=cl>    <span class=n>policy</span> <span class=o>=</span> <span class=n>make_policy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>cfg</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ds_meta</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create processors - only provide dataset_stats if not resuming from saved processors</span>
</span></span><span class=line><span class=cl>    <span class=n>processor_kwargs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>postprocessor_kwargs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>pretrained_path</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>cfg</span><span class=o>.</span><span class=n>resume</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>pretrained_path</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Only provide dataset_stats when not resuming from saved processor state</span>
</span></span><span class=line><span class=cl>        <span class=n>processor_kwargs</span><span class=p>[</span><span class=s2>&#34;dataset_stats&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>pretrained_path</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>processor_kwargs</span><span class=p>[</span><span class=s2>&#34;preprocessor_overrides&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;device_processor&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;device&#34;</span><span class=p>:</span> <span class=n>device</span><span class=o>.</span><span class=n>type</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;normalizer_processor&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;stats&#34;</span><span class=p>:</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>stats</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;features&#34;</span><span class=p>:</span> <span class=p>{</span><span class=o>**</span><span class=n>policy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>input_features</span><span class=p>,</span> <span class=o>**</span><span class=n>policy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>output_features</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;norm_map&#34;</span><span class=p>:</span> <span class=n>policy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>normalization_mapping</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>postprocessor_kwargs</span><span class=p>[</span><span class=s2>&#34;postprocessor_overrides&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;unnormalizer_processor&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;stats&#34;</span><span class=p>:</span> <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>stats</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;features&#34;</span><span class=p>:</span> <span class=n>policy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>output_features</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;norm_map&#34;</span><span class=p>:</span> <span class=n>policy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>normalization_mapping</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>preprocessor</span><span class=p>,</span> <span class=n>postprocessor</span> <span class=o>=</span> <span class=n>make_pre_post_processors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>policy_cfg</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pretrained_path</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>pretrained_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>**</span><span class=n>processor_kwargs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>**</span><span class=n>postprocessor_kwargs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Creating optimizer and scheduler&#34;</span><span class=p>)</span>  <span class=c1># 正在创建优化器与调度器</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=p>,</span> <span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>make_optimizer_and_scheduler</span><span class=p>(</span><span class=n>cfg</span><span class=p>,</span> <span class=n>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scaler</span> <span class=o>=</span> <span class=n>GradScaler</span><span class=p>(</span><span class=n>device</span><span class=o>.</span><span class=n>type</span><span class=p>,</span> <span class=n>enabled</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>use_amp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>step</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># number of policy updates (forward + backward + optim)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>resume</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>load_training_state</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>checkpoint_path</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>lr_scheduler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>num_learnable_params</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>numel</span><span class=p>()</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>policy</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span> <span class=k>if</span> <span class=n>p</span><span class=o>.</span><span class=n>requires_grad</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>num_total_params</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>numel</span><span class=p>()</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>policy</span><span class=o>.</span><span class=n>parameters</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;Output dir:&#34;</span><span class=p>,</span> <span class=s2>&#34;yellow&#34;</span><span class=p>,</span> <span class=n>attrs</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;bold&#34;</span><span class=p>])</span> <span class=o>+</span> <span class=sa>f</span><span class=s2>&#34; </span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>output_dir</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 输出目录</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>env</span><span class=o>.</span><span class=n>task</span><span class=si>=}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>cfg</span><span class=o>.</span><span class=n>steps</span><span class=si>=}</span><span class=s2> (</span><span class=si>{</span><span class=n>format_big_number</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>steps</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>num_frames</span><span class=si>=}</span><span class=s2> (</span><span class=si>{</span><span class=n>format_big_number</span><span class=p>(</span><span class=n>dataset</span><span class=o>.</span><span class=n>num_frames</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>num_episodes</span><span class=si>=}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>num_learnable_params</span><span class=si>=}</span><span class=s2> (</span><span class=si>{</span><span class=n>format_big_number</span><span class=p>(</span><span class=n>num_learnable_params</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>num_total_params</span><span class=si>=}</span><span class=s2> (</span><span class=si>{</span><span class=n>format_big_number</span><span class=p>(</span><span class=n>num_total_params</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># create dataloader for offline training</span>
</span></span><span class=line><span class=cl>    <span class=c1># 为离线训练创建数据加载器</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=p>,</span> <span class=s2>&#34;drop_n_last_frames&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>shuffle</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span> <span class=o>=</span> <span class=n>EpisodeAwareSampler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>episodes</span><span class=p>[</span><span class=s2>&#34;dataset_from_index&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>dataset</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>episodes</span><span class=p>[</span><span class=s2>&#34;dataset_to_index&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>drop_n_last_frames</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>drop_n_last_frames</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>shuffle</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dataloader</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>DataLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>num_workers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>shuffle</span><span class=o>=</span><span class=n>shuffle</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>cfg</span><span class=o>.</span><span class=n>dataset</span><span class=o>.</span><span class=n>streaming</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span><span class=o>=</span><span class=n>sampler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pin_memory</span><span class=o>=</span><span class=n>device</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;cuda&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>drop_last</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>prefetch_factor</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dl_iter</span> <span class=o>=</span> <span class=n>cycle</span><span class=p>(</span><span class=n>dataloader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>policy</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>train_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;loss&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;loss&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;grad_norm&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;grdn&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lr&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;lr&#34;</span><span class=p>,</span> <span class=s2>&#34;:0.1e&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;update_s&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;updt_s&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dataloading_s&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;data_s&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>train_tracker</span> <span class=o>=</span> <span class=n>MetricsTracker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>cfg</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>dataset</span><span class=o>.</span><span class=n>num_frames</span><span class=p>,</span> <span class=n>dataset</span><span class=o>.</span><span class=n>num_episodes</span><span class=p>,</span> <span class=n>train_metrics</span><span class=p>,</span> <span class=n>initial_step</span><span class=o>=</span><span class=n>step</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Start offline training on a fixed dataset&#34;</span><span class=p>)</span>  <span class=c1># 开始在固定数据集上进行离线训练</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>step</span><span class=p>,</span> <span class=n>cfg</span><span class=o>.</span><span class=n>steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>dl_iter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>train_tracker</span><span class=o>.</span><span class=n>dataloading_s</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>train_tracker</span><span class=p>,</span> <span class=n>output_dict</span> <span class=o>=</span> <span class=n>update_policy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>train_tracker</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>policy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>optimizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>cfg</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>grad_clip_norm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>grad_scaler</span><span class=o>=</span><span class=n>grad_scaler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>lr_scheduler</span><span class=o>=</span><span class=n>lr_scheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>use_amp</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>use_amp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Note: eval and checkpoint happens *after* the `step`th training update has completed, so we</span>
</span></span><span class=line><span class=cl>        <span class=c1># 评估与保存发生在完成该步更新之后</span>
</span></span><span class=line><span class=cl>        <span class=c1># increment `step` here.</span>
</span></span><span class=line><span class=cl>        <span class=c1># 因此此处递增 step</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>train_tracker</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>is_log_step</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>log_freq</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>step</span> <span class=o>%</span> <span class=n>cfg</span><span class=o>.</span><span class=n>log_freq</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>is_saving_step</span> <span class=o>=</span> <span class=n>step</span> <span class=o>%</span> <span class=n>cfg</span><span class=o>.</span><span class=n>save_freq</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>step</span> <span class=o>==</span> <span class=n>cfg</span><span class=o>.</span><span class=n>steps</span>
</span></span><span class=line><span class=cl>        <span class=n>is_eval_step</span> <span class=o>=</span> <span class=n>cfg</span><span class=o>.</span><span class=n>eval_freq</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>step</span> <span class=o>%</span> <span class=n>cfg</span><span class=o>.</span><span class=n>eval_freq</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_log_step</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>train_tracker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>wandb_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_log_dict</span> <span class=o>=</span> <span class=n>train_tracker</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>output_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>wandb_log_dict</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>output_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_logger</span><span class=o>.</span><span class=n>log_dict</span><span class=p>(</span><span class=n>wandb_log_dict</span><span class=p>,</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>swanlab_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_log_dict</span> <span class=o>=</span> <span class=n>train_tracker</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>output_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>swanlab_log_dict</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>output_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_logger</span><span class=o>.</span><span class=n>log_dict</span><span class=p>(</span><span class=n>swanlab_log_dict</span><span class=p>,</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>train_tracker</span><span class=o>.</span><span class=n>reset_averages</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>save_checkpoint</span> <span class=ow>and</span> <span class=n>is_saving_step</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Checkpoint policy after step </span><span class=si>{</span><span class=n>step</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 保存检查点</span>
</span></span><span class=line><span class=cl>            <span class=n>checkpoint_dir</span> <span class=o>=</span> <span class=n>get_step_checkpoint_dir</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>cfg</span><span class=o>.</span><span class=n>steps</span><span class=p>,</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>save_checkpoint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>checkpoint_dir</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>cfg</span><span class=p>,</span> <span class=n>policy</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>lr_scheduler</span><span class=p>,</span> <span class=n>preprocessor</span><span class=p>,</span> <span class=n>postprocessor</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>update_last_checkpoint</span><span class=p>(</span><span class=n>checkpoint_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>wandb_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_logger</span><span class=o>.</span><span class=n>log_policy</span><span class=p>(</span><span class=n>checkpoint_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>swanlab_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_logger</span><span class=o>.</span><span class=n>log_policy</span><span class=p>(</span><span class=n>checkpoint_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>env</span> <span class=ow>and</span> <span class=n>is_eval_step</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span> <span class=o>=</span> <span class=n>get_step_identifier</span><span class=p>(</span><span class=n>step</span><span class=p>,</span> <span class=n>cfg</span><span class=o>.</span><span class=n>steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Eval policy at step </span><span class=si>{</span><span class=n>step</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 评估策略</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=n>device_type</span><span class=o>=</span><span class=n>device</span><span class=o>.</span><span class=n>type</span><span class=p>)</span> <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>use_amp</span> <span class=k>else</span> <span class=n>nullcontext</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>eval_info</span> <span class=o>=</span> <span class=n>eval_policy_all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>envs</span><span class=o>=</span><span class=n>eval_env</span><span class=p>,</span>  <span class=c1># dict[suite][task_id] -&gt; vec_env</span>
</span></span><span class=line><span class=cl>                    <span class=n>policy</span><span class=o>=</span><span class=n>policy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>preprocessor</span><span class=o>=</span><span class=n>preprocessor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>postprocessor</span><span class=o>=</span><span class=n>postprocessor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>n_episodes</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>eval</span><span class=o>.</span><span class=n>n_episodes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>videos_dir</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>output_dir</span> <span class=o>/</span> <span class=s2>&#34;eval&#34;</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;videos_step_</span><span class=si>{</span><span class=n>step_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>max_episodes_rendered</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>start_seed</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>seed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>max_parallel_tasks</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>env</span><span class=o>.</span><span class=n>max_parallel_tasks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># overall metrics (suite-agnostic)</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregated</span> <span class=o>=</span> <span class=n>eval_info</span><span class=p>[</span><span class=s2>&#34;overall&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># optional: per-suite logging</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>suite</span><span class=p>,</span> <span class=n>suite_info</span> <span class=ow>in</span> <span class=n>eval_info</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Suite </span><span class=si>%s</span><span class=s2> aggregated: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>suite</span><span class=p>,</span> <span class=n>suite_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># meters/tracker</span>
</span></span><span class=line><span class=cl>            <span class=n>eval_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;avg_sum_reward&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;∑rwrd&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;pc_success&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=s2>&#34;:.1f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;eval_s&#34;</span><span class=p>:</span> <span class=n>AverageMeter</span><span class=p>(</span><span class=s2>&#34;eval_s&#34;</span><span class=p>,</span> <span class=s2>&#34;:.3f&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>eval_tracker</span> <span class=o>=</span> <span class=n>MetricsTracker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>cfg</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>dataset</span><span class=o>.</span><span class=n>num_frames</span><span class=p>,</span> <span class=n>dataset</span><span class=o>.</span><span class=n>num_episodes</span><span class=p>,</span> <span class=n>eval_metrics</span><span class=p>,</span> <span class=n>initial_step</span><span class=o>=</span><span class=n>step</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>eval_tracker</span><span class=o>.</span><span class=n>eval_s</span> <span class=o>=</span> <span class=n>aggregated</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;eval_s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>eval_tracker</span><span class=o>.</span><span class=n>avg_sum_reward</span> <span class=o>=</span> <span class=n>aggregated</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;avg_sum_reward&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>eval_tracker</span><span class=o>.</span><span class=n>pc_success</span> <span class=o>=</span> <span class=n>aggregated</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;pc_success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>wandb_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_log_dict</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=n>eval_tracker</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(),</span> <span class=o>**</span><span class=n>eval_info</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_logger</span><span class=o>.</span><span class=n>log_dict</span><span class=p>(</span><span class=n>wandb_log_dict</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;eval&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>wandb_logger</span><span class=o>.</span><span class=n>log_video</span><span class=p>(</span><span class=n>eval_info</span><span class=p>[</span><span class=s2>&#34;overall&#34;</span><span class=p>][</span><span class=s2>&#34;video_paths&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>step</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;eval&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>swanlab_logger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_log_dict</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=n>eval_tracker</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(),</span> <span class=o>**</span><span class=n>eval_info</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_logger</span><span class=o>.</span><span class=n>log_dict</span><span class=p>(</span><span class=n>swanlab_log_dict</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;eval&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>swanlab_logger</span><span class=o>.</span><span class=n>log_video</span><span class=p>(</span><span class=n>eval_info</span><span class=p>[</span><span class=s2>&#34;overall&#34;</span><span class=p>][</span><span class=s2>&#34;video_paths&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>step</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;eval&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>eval_env</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>close_envs</span><span class=p>(</span><span class=n>eval_env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;End of training&#34;</span><span class=p>)</span>  <span class=c1># 训练结束</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>push_to_hub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>policy</span><span class=o>.</span><span class=n>push_model_to_hub</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>preprocessor</span><span class=o>.</span><span class=n>push_to_hub</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>repo_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>postprocessor</span><span class=o>.</span><span class=n>push_to_hub</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>policy</span><span class=o>.</span><span class=n>repo_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>init_logging</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>train</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div></li></ul></div></div></div><ol start=0><li>安装 SwanLab：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install swanlab
</span></span></code></pre></div></li><li>在官网登录后获得<code>API Key</code>，运行 <code>swanlab login</code> 登录</li><li>创建训练日志文件夹：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p ./logs
</span></span></code></pre></div></li><li>开始训练（100000 步）：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>stdbuf -oL -eL nohup python -m lerobot.extra.lerobot_train_swanlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--dataset.repo_id<span class=o>=</span>xiadengma/so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--dataset.root<span class=o>=</span>./data/datasets/xiadengma/so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--policy.type<span class=o>=</span>act <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--output_dir<span class=o>=</span>./data/train/act_so101_red_pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--job_name<span class=o>=</span>act_so101_red_pepper_<span class=k>$(</span>date +%Y%m%d_%H%M%S<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--policy.device<span class=o>=</span>cuda <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--wandb.enable<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--policy.push_to_hub<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--steps<span class=o>=</span><span class=m>100000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--tracker<span class=o>=</span>swanlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--swanlab.project<span class=o>=</span>so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--swanlab.mode<span class=o>=</span>cloud <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>&gt; ./logs/train_<span class=k>$(</span>date +<span class=s2>&#34;%Y-%m-%d-%H-%M-%S&#34;</span><span class=k>)</span>.log 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span> <span class=nb>echo</span> <span class=nv>$!</span> &gt; ./logs/train.pid
</span></span></code></pre></div></li><li>恢复训练：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>stdbuf -oL -eL nohup lerobot-train <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--config_path<span class=o>=</span>./data/train/act_so101_red_pepper/checkpoints/last/pretrained_model/train_config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--resume<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>&gt; ./logs/resume_<span class=k>$(</span>date +<span class=s2>&#34;%Y-%m-%d-%H-%M-%S&#34;</span><span class=k>)</span>.log 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span> <span class=nb>echo</span> <span class=nv>$!</span> &gt; ./logs/train.pid
</span></span></code></pre></div></li><li>查看最新日志：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tail -f <span class=k>$(</span>ls -t ./logs/*.log <span class=p>|</span> head -n 1<span class=k>)</span>
</span></span></code></pre></div></li><li>中断训练：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>kill</span> -TERM <span class=k>$(</span>cat ./logs/train.pid<span class=k>)</span> <span class=o>||</span> <span class=nb>kill</span> -KILL <span class=k>$(</span>cat ./logs/train.pid<span class=k>)</span>
</span></span></code></pre></div></li></ol><h2 class="relative group">运行推断并评估<div id=运行推断并评估 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e8%bf%90%e8%a1%8c%e6%8e%a8%e6%96%ad%e5%b9%b6%e8%af%84%e4%bc%b0 aria-label=锚点>#</a></span></h2><ol><li>运行推断<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> python -m lerobot.extra.lerobot_record_web <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --robot.type<span class=o>=</span>so101_follower <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --robot.port<span class=o>=</span>/dev/follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --robot.cameras<span class=o>=</span><span class=s2>&#34;{ wrist_left: {type: opencv, index_or_path: 2, width: 640, height: 480, fps: 30}, front_rgb: {type: opencv, index_or_path: 8, width: 640, height: 480, fps: 30}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --robot.id<span class=o>=</span>my_follower_arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --robot.calibration_dir<span class=o>=</span>./data/calibration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --display_data<span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.repo_id<span class=o>=</span>xiadengma/eval_so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.single_task<span class=o>=</span><span class=s2>&#34;Put the red pepper toy in the cardboard box&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --policy.path<span class=o>=</span>./data/train/act_so101_red_pepper/checkpoints/last/pretrained_model <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --policy.device<span class=o>=</span>cuda <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.root<span class=o>=</span>./data/datasets/xiadengma/eval_so101-red-pepper <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --web_port<span class=o>=</span><span class=m>9090</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.episode_time_s<span class=o>=</span><span class=m>30</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.reset_time_s<span class=o>=</span><span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> --dataset.num_episodes<span class=o>=</span><span class=m>10</span>
</span></span></code></pre></div></li><li>评估<ul><li>对于数据集要求高</li><li>泛化能力较差</li></ul></li></ol><style>.video-caption>*{margin:0!important;padding:0;line-height:1.5}</style><figure class=my-6 style=max-width:85%;margin-left:auto;margin-right:auto><figcaption class="video-caption text-center text-base text-neutral-700 dark:text-neutral-200 font-semibold" style=margin-bottom:.25rem>ACT推理演示视频（3个回合，抓取红辣椒玩偶并放入纸箱）</figcaption><div class="w-full rounded-md shadow-lg bf-video-wrapper" data-aspect=16-9 style=margin:0;padding:0;line-height:0><video class="w-full h-auto rounded-md nozoom bf-video" style=display:block;margin:0;padding:0 controls playsinline webkit-playsinline preload=metadata poster=/posts/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5/video/ACT%E6%8E%A8%E7%90%86%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91%E5%B0%81%E9%9D%A2.png>
<source src=/posts/lerobot-so-101-%E6%9C%BA%E6%A2%B0%E8%87%82%E5%AE%9E%E8%B7%B5/video/ACT%E6%8E%A8%E7%90%86%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91.mp4 type=video/mp4>您的浏览器不支持 video 标签。</video></div></figure><h2 class="relative group"><em>88. 参考资料</em><div id=88-参考资料 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#88-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=锚点>#</a></span></h2><div class="expand-wrapper prose dark:prose-invert max-w-prose zen-mode-content"><input id=expand-9 class=expand-toggle type=checkbox>
<label for=expand-9 class=expand-title><span class=expand-icon><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg>
</span>点击展开查看参考资料</label><div class=expand-content><div class=expand-inner><ul><li><a href=https://github.com/huggingface/lerobot target=_blank>LeRobot 仓库</a></li><li><a href=https://huggingface.co/docs/lerobot/installation target=_blank>官方-安装文档</a></li><li><a href=https://huggingface.co/docs/lerobot/so101 target=_blank>官方-so101 文档</a></li><li><a href=https://wiki.seeedstudio.com/cn/lerobot_so100m_new/ target=_blank>seeedstudio-基于 LeRobot 的 SO-ARM100 and SO-ARM101 机械臂入门教程</a></li><li><a href="https://www.bilibili.com/video/BV13bLyzKES8?t=3991.4" target=_blank>wowrobo-摄像头连接教程</a></li><li><a href=https://www.bilibili.com/video/BV1w81mYZEVb target=_blank>wowrobo-LeRobot 具身智能机械臂实操入门课程</a></li></ul></div></div></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt=xiadengma src=/img/author_hu_76f37802f31e48ac.jpg data-zoom-src=/img/author.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">xiadengma</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/xiadengma target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://xiadengma.com/ target=_blank aria-label=Link title=Link rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1c55.6-55.59 148-55.59 203.6.0 50 50 57.4 129.7 16.3 187.2L391.3 319.9C381 334.2 361 337.6 346.7 327.3c-14.4-10.3-17.8-30.3-7.5-44.6L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2c-31.4-31.4-82.5-31.4-114 0L105.5 289.5c-31.51 30.6-31.51 82.5.0 114C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4 265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2c-58.4 41.1-136.3 34.5-186.29-15.4-56.469-56.5-56.469-148.1.0-204.5L172.5 131.1zM467.5 380c-56.5 56.5-148 56.5-204.5.0-50-50-56.5-128.8-15.4-186.3L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7 307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8c31.4 31.4 82.5 31.4 114 0L534.5 222.5c31.5-31.5 31.5-83.4.0-114C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58 374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24c56.5 56.46 56.5 148.06.0 204.46L467.5 380z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div></div><script>var oid="views_posts/LeRobot SO-101 机械臂实践/index.md",oid_likes="likes_posts/LeRobot SO-101 机械臂实践/index.md"</script><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;深入浅出卡尔曼滤波
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-09-19T09:49:00+08:00>2025年9月19日</time>
</span></span><span class="flex flex-col items-end"></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 <a href=https://xiadengma.com target=_blank>XIADENGMA</a> | All rights reserved | <a href=https://beian.miit.gov.cn target=_blank>浙ICP备20005376号-2</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">🛸 by Hugo & Blowfish</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script src=https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js></script><script>function css(e){return"rgb("+getComputedStyle(document.documentElement).getPropertyValue(e)+")"}mermaid.initialize({startOnLoad:!0,theme:"base",themeVariables:{background:css("--color-neutral"),primaryColor:css("--color-primary-200"),secondaryColor:css("--color-secondary-200"),tertiaryColor:css("--color-neutral-100"),primaryBorderColor:css("--color-primary-400"),secondaryBorderColor:css("--color-secondary-400"),tertiaryBorderColor:css("--color-neutral-400"),lineColor:"#ffffff",fontFamily:"ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,noto sans,sans-serif",fontSize:"16px"}}),document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){const e=document.querySelectorAll(".mermaid svg");e.forEach(e=>{const n=(new XMLSerializer).serializeToString(e),t=document.createElement("img"),s=new Blob([n],{type:"image/svg+xml"}),o=URL.createObjectURL(s);t.src=o,t.style.width="100%",t.style.maxWidth=e.getAttribute("width")||"100%",t.style.height="auto",t.alt="Mermaid diagram",e.parentNode.replaceChild(t,e),mediumZoom(t,{margin:24,background:"rgba(0,0,0,0.8)",scrollOffset:99999})})},1e3)})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://blog.xiadengma.com/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>